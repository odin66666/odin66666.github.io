<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quadrato Magico</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #1a1a2e, #16213e); color: #fff; min-height: 100vh; padding: 15px; }
        .container { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 15px; }
        .symbol { font-size: 3rem; margin-bottom: 5px; }
        h1 { color: #ffd700; font-size: 1.2rem; }
        .day-info { color: #888; font-size: 0.9rem; margin-top: 5px; }
        .card { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(255,215,0,0.3); }
        .vibrations-today { text-align: center; margin-bottom: 15px; }
        .vibrations-today h2 { color: #ffd700; font-size: 1rem; margin-bottom: 10px; }
        .vibrations-number { font-size: 3.5rem; font-weight: bold; color: #ffd700; }
        .vibrations-label { color: #888; font-size: 0.9rem; }
        .mantra { background: rgba(123,44,191,0.2); border-radius: 10px; padding: 12px; text-align: center; margin-bottom: 15px; }
        .mantra-text { color: #ffd700; font-size: 1.1rem; letter-spacing: 1px; }
        .mantra-pron { color: #888; font-size: 0.8rem; font-style: italic; margin-top: 5px; }
        .count { text-align: center; font-size: 3.5rem; font-weight: bold; color: #ffd700; }
        .total { text-align: center; color: #888; margin-bottom: 10px; }
        .progress { height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; overflow: hidden; margin-bottom: 15px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #7b2cbf, #ffd700); transition: width 0.3s; }
        .buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .btn { padding: 15px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; color: #fff; }
        .btn:active { transform: scale(0.95); }
        .btn-add { background: linear-gradient(135deg, #7b2cbf, #9d4edd); }
        .btn-main { grid-column: span 3; padding: 18px; font-size: 1.3rem; background: linear-gradient(135deg, #ffd700, #ffaa00); color: #1a1a1a; }
        .btn-save { grid-column: span 3; padding: 18px; font-size: 1.2rem; background: #10b981; margin-top: 15px; }
        .message { text-align: center; min-height: 25px; color: #ffd700; margin: 10px 0; }
        .debug { background: rgba(0,0,0,0.5); color: #0f0; font-size: 11px; padding: 10px; border-radius: 8px; margin-top: 15px; max-height: 80px; overflow: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="symbol" id="symbol">☉</div>
            <h1 id="title">QUADRATO DEL SOLE</h1>
            <div class="day-info">Giorno <span id="day">1</span> di <span id="totalDays">36</span></div>
        </div>
        
        <div class="card">
            <div class="vibrations-today">
                <h2>VIBRAZIONI OGGI</h2>
                <div class="vibrations-number" id="vibToday">111</div>
                <div class="vibrations-label">volte il mantra</div>
            </div>
            
            <div class="mantra">
                <div class="mantra-text" id="mantra">SURYAYE</div>
                <div class="mantra-pron" id="pron">(pronuncia)</div>
            </div>
            
            <div class="count" id="count">0</div>
            <div class="total">di <span id="total">111</span></div>
            <div class="progress"><div class="progress-fill" id="progress"></div></div>
            <div class="message" id="message"></div>
            
            <div class="buttons">
                <button class="btn btn-add" onclick="add(1)">+1</button>
                <button class="btn btn-add" onclick="add(5)">+5</button>
                <button class="btn btn-add" onclick="add(10)">+10</button>
                <button class="btn btn-main" onclick="add(1)">⚡ VIBRA ⚡</button>
                <button class="btn btn-save" id="saveBtn" onclick="save()">✅ SALVA E CHIUDI</button>
            </div>
        </div>
        
        <div class="debug" id="debug">Debug...</div>
    </div>
    
    <script>
        const PLANETS = {
            saturn: { symbol: '♄', name: 'SATURNO', days: 15 },
            jupiter: { symbol: '♃', name: 'GIOVE', days: 16 },
            mars: { symbol: '♂', name: 'MARTE', days: 25 },
            sun: { symbol: '☉', name: 'SOLE', days: 36 },
            venus: { symbol: '♀', name: 'VENERE', days: 49 },
            mercury: { symbol: '☿', name: 'MERCURIO', days: 64 },
            moon: { symbol: '☽', name: 'LUNA', days: 81 }
        };
        
        let count = 0;
        let total = 111;
        let workId = '';
        let affReps = 0;
        
        function log(msg) {
            console.log('[SQUARE]', msg);
            document.getElementById('debug').innerHTML += '<br>' + msg;
        }
        
        function init() {
            log('Init...');
            
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.ready();
                log('Telegram OK');
            } else {
                log('NO Telegram WebApp!');
            }
            
            const p = new URLSearchParams(window.location.search);
            workId = p.get('work_id') || '';
            const planet = p.get('planet') || 'sun';
            const day = parseInt(p.get('day')) || 1;
            total = parseInt(p.get('vibrations')) || parseInt(p.get('total')) || 111;
            affReps = parseInt(p.get('aff_reps')) || 0;
            
            const info = PLANETS[planet] || PLANETS.sun;
            document.getElementById('symbol').textContent = info.symbol;
            document.getElementById('title').textContent = 'QUADRATO ' + info.name;
            document.getElementById('day').textContent = day;
            document.getElementById('totalDays').textContent = info.days;
            document.getElementById('vibToday').textContent = total;
            document.getElementById('total').textContent = total;
            
            const mantra = decodeURIComponent(p.get('mantra') || '');
            const pron = decodeURIComponent(p.get('pronunciation') || '');
            document.getElementById('mantra').textContent = mantra || 'MANTRA';
            document.getElementById('pron').textContent = pron ? '(' + pron + ')' : '';
            
            log('work_id=' + workId + ', planet=' + planet + ', day=' + day + ', vibrations=' + total);
            
            update();
        }
        
        function add(n) {
            if (count >= total) return;
            count = Math.min(count + n, total);
            update();
            
            if (count >= total) {
                document.getElementById('message').textContent = '✅ COMPLETATO!';
                log('Completato!');
            }
        }
        
        function update() {
            document.getElementById('count').textContent = count;
            document.getElementById('progress').style.width = Math.round((count / total) * 100) + '%';
            
            const left = total - count;
            if (left > 0 && left <= 5) {
                document.getElementById('message').textContent = '⚡ ULTIME ' + left + '!';
            } else if (left > 5) {
                document.getElementById('message').textContent = '';
            }
        }
        
        function save() {
            log('Salvataggio...');
            
            const data = {
                action: 'counter_complete',
                work_id: workId,
                vibrations: count,
                affirmations: affReps,
                total_vibrations: total,
                total_affirmations: affReps
            };
            
            const json = JSON.stringify(data);
            log('Dati: ' + json);
            
            if (window.Telegram && window.Telegram.WebApp) {
                try {
                    log('sendData...');
                    window.Telegram.WebApp.sendData(json);
                    log('OK!');
                    setTimeout(() => window.Telegram.WebApp.close(), 500);
                } catch (e) {
                    log('ERRORE: ' + e.message);
                    alert('Errore: ' + e.message);
                }
            } else {
                alert('Dati:\n' + json);
            }
        }
        
        init();
    </script>
</body>
</html>
