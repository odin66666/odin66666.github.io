<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quadrato Magico</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cinzel', serif; background: #0a0a12; color: #e8e8e8; min-height: 100vh; padding: 10px; }
        .header { text-align: center; margin-bottom: 10px; }
        .header h1 { font-size: 1.2rem; color: #d4af37; }
        .planet-symbol { font-size: 2.5rem; margin: 5px 0; }
        .subtitle { font-size: 0.8rem; color: #888; }
        .step-indicator { display: flex; justify-content: center; gap: 8px; margin: 10px 0; }
        .step { padding: 6px 12px; border-radius: 15px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: #888; }
        .step.active { background: linear-gradient(135deg, #7b2cbf, #d4af37); color: white; }
        .step.completed { background: #10b981; color: white; }
        .square-container { display: flex; justify-content: center; margin: 10px 0; }
        .square-grid { display: grid; gap: 2px; background: #12121f; padding: 8px; border-radius: 12px; border: 2px solid #d4af37; }
        .cell { display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 4px; font-weight: bold; }
        .cell.completed { background: rgba(16, 185, 129, 0.3); color: #10b981; }
        .cell.current { background: linear-gradient(135deg, rgba(212, 175, 55, 0.5), rgba(123, 44, 191, 0.5)); border: 2px solid #d4af37; animation: pulse 2s infinite; }
        .cell.completed-today { background: linear-gradient(135deg, rgba(16, 185, 129, 0.6), rgba(212, 175, 55, 0.4)); border: 2px solid #10b981; color: #10b981; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .day-info { background: #12121f; border-radius: 12px; padding: 12px; margin: 10px 0; border: 1px solid rgba(212, 175, 55, 0.3); text-align: center; }
        .day-info h2 { color: #d4af37; font-size: 1rem; margin-bottom: 8px; }
        .vibration-count { font-size: 3rem; color: #d4af37; }
        .vibration-label { font-size: 0.85rem; color: #888; }
        .mantra-section { background: #12121f; border-radius: 10px; padding: 10px; margin: 8px 0; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .mantra-text { font-size: 1.1rem; color: #f4d675; }
        .mantra-pronunciation { font-size: 0.75rem; color: #888; font-style: italic; margin-top: 3px; }
        .counter-section { background: #12121f; border-radius: 12px; padding: 12px; margin: 10px 0; border: 1px solid rgba(123, 44, 191, 0.3); }
        .counter-display { text-align: center; margin-bottom: 10px; }
        .counter-number { font-size: 2.5rem; color: #d4af37; }
        .progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #7b2cbf, #d4af37); transition: width 0.3s; }
        .counter-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .btn { padding: 12px; font-size: 1.1rem; font-weight: bold; font-family: 'Cinzel', serif; border: none; border-radius: 10px; cursor: pointer; color: white; transition: opacity 0.3s; }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { cursor: not-allowed; transform: none; }
        .btn-add { background: linear-gradient(135deg, #7b2cbf, #9d4edd); }
        .btn-vibra { grid-column: span 3; padding: 15px; font-size: 1.2rem; background: linear-gradient(135deg, #d4af37, #c9a227); color: #1a1a1a; }
        .btn-save { grid-column: span 3; padding: 15px; font-size: 1.1rem; background: linear-gradient(135deg, #10b981, #059669); margin-top: 10px; }
        .btn-close { width: 100%; padding: 15px; font-size: 1.1rem; background: #444; margin-top: 10px; }
        .affirmation-section { background: #12121f; border-radius: 12px; padding: 15px; margin: 10px 0; border: 1px solid rgba(123, 44, 191, 0.3); display: none; }
        .affirmation-title { color: #d4af37; font-size: 1rem; text-align: center; margin-bottom: 10px; }
        .affirmation-text { background: rgba(123, 44, 191, 0.15); border-radius: 10px; padding: 15px; font-style: italic; font-size: 0.95rem; border-left: 3px solid #7b2cbf; margin-bottom: 15px; text-align: center; color: #f4d675; }
        .message { text-align: center; font-size: 0.9rem; color: #f4d675; min-height: 22px; margin: 8px 0; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 0.8rem; color: #888; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 8px; }
        .toggle { position: relative; width: 40px; height: 22px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.2); border-radius: 22px; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle input:checked + .toggle-slider { background: #d4af37; }
        .toggle input:checked + .toggle-slider:before { transform: translateX(18px); }
        .completed-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(212, 175, 55, 0.95), rgba(123, 44, 191, 0.95)); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .completed-overlay.show { display: flex; }
        .completed-icon { font-size: 4rem; margin-bottom: 10px; }
        .completed-text { font-size: 1.5rem; color: #1a1a1a; margin-bottom: 20px; }
        .close-btn { padding: 12px 30px; background: #1a1a1a; color: #d4af37; border: 2px solid #d4af37; border-radius: 25px; font-family: 'Cinzel', serif; font-size: 1rem; cursor: pointer; }
        .view-only-banner { background: #10b981; color: white; text-align: center; padding: 10px; border-radius: 10px; margin-bottom: 10px; display: none; font-size: 0.9rem; }
        .view-only-info { background: #12121f; border-radius: 12px; padding: 15px; margin: 10px 0; border: 1px solid rgba(16, 185, 129, 0.3); display: none; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #888; }
        .info-value { color: #d4af37; font-weight: bold; }
        .progress-visual { background: rgba(255,255,255,0.1); border-radius: 10px; height: 20px; overflow: hidden; margin: 10px 0; }
        .progress-visual-fill { height: 100%; background: linear-gradient(90deg, #10b981, #d4af37); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #1a1a1a; font-weight: bold; }
        .view-mantra { background: rgba(212, 175, 55, 0.1); border-radius: 10px; padding: 12px; margin-top: 10px; text-align: center; }
        .view-mantra-label { font-size: 0.75rem; color: #888; margin-bottom: 5px; }
        .view-mantra-text { font-size: 1rem; color: #f4d675; }
        .view-affirmation { background: rgba(123, 44, 191, 0.1); border-radius: 10px; padding: 12px; margin-top: 10px; }
        .view-affirmation-label { font-size: 0.75rem; color: #888; margin-bottom: 5px; text-align: center; }
        .view-affirmation-text { font-size: 0.9rem; color: #e8e8e8; font-style: italic; text-align: center; }
        .planet-hour-bar { background: #12121f; border-radius: 8px; padding: 10px; margin: 10px 0; text-align: center; border: 1px solid rgba(212,175,55,0.3); }
        .planet-hour-bar .lbl { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 4px; }
        .planet-hour-bar .planet { font-size: 1rem; font-weight: bold; }
        .c-sun { color: #ffd700; } .c-moon { color: #c0c0c0; } .c-mars { color: #ff4444; }
        .c-mercury { color: #cd853f; } .c-jupiter { color: #ff8c00; } .c-venus { color: #90ee90; } .c-saturn { color: #708090; }
        .avg-time { font-size: 0.75rem; color: #888; text-align: center; margin: 8px 0; }
        .extra-controls { display: flex; gap: 8px; margin-top: 8px; }
        .ctrl-btn { flex: 1; padding: 10px; border: 1px solid #555; background: transparent; color: #888; border-radius: 8px; font-size: 0.8rem; cursor: pointer; font-family: 'Cinzel', serif; }
        .ctrl-btn:active { border-color: #d4af37; color: #d4af37; }
        .warning-popup { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .warning-popup.show { display: flex; }
        .warning-box { background: #12121f; border: 2px solid #fbbf24; border-radius: 16px; padding: 25px; max-width: 350px; text-align: center; }
        .warning-box .icon { font-size: 50px; margin-bottom: 15px; }
        .warning-box .title { font-size: 1.1rem; color: #fbbf24; font-weight: bold; margin-bottom: 10px; }
        .warning-box .msg { font-size: 0.9rem; color: #e8e8e8; margin-bottom: 8px; }
        .warning-box .detail { font-size: 0.8rem; color: #888; margin-bottom: 20px; }
        .warning-box .btns { display: flex; gap: 10px; }
        .warning-box .btns button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: bold; cursor: pointer; font-family: 'Cinzel', serif; }
        .warning-box .btn-cancel { background: #ef4444; color: #fff; }
        .warning-box .btn-confirm { background: #10b981; color: #000; }
        .history-popup { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); display: none; z-index: 2000; overflow-y: auto; padding: 20px; }
        .history-popup.show { display: block; }
        .history-box { background: #12121f; border-radius: 12px; padding: 20px; max-width: 400px; margin: 0 auto; }
        .history-box .title { font-size: 1rem; color: #d4af37; font-weight: bold; margin-bottom: 15px; text-align: center; }
        .history-list { max-height: 400px; overflow-y: auto; }
        .history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; }
        .history-item .rep { color: #d4af37; font-weight: bold; }
        .history-item .time { color: #888; }
        .history-item .delta { color: #e8e8e8; }
        .history-item.warning { background: rgba(251,191,36,0.2); }
        .admin-section { background: rgba(239,68,68,0.1); border: 1px solid #ef4444; border-radius: 10px; padding: 10px; margin: 10px 0; display: none; }
        .admin-section.show { display: block; }
        .btn-admin-reset { width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-family: 'Cinzel', serif; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <div class="planet-symbol" id="planetSymbol">&#9737;</div>
        <h1 id="squareTitle">QUADRATO</h1>
        <div class="subtitle">Giorno <span id="currentDay">1</span> di <span id="totalDays">36</span></div>
    </div>
    
    <div class="planet-hour-bar" id="planetHourBar">
        <div class="lbl">Ora Planetaria Inizio</div>
        <div class="planet" id="startPlanetHour">Calcolo...</div>
    </div>
    
    <div class="view-only-banner" id="viewOnlyBanner">GIORNO <span id="completedDayNum">1</span> COMPLETATO</div>
    
    <div class="step-indicator" id="stepIndicator">
        <div class="step active" id="step1">Vibrazioni</div>
        <div class="step" id="step2">Affermazioni</div>
    </div>
    
    <div class="square-container"><div class="square-grid" id="squareGrid"></div></div>
    
    <div class="view-only-info" id="viewOnlyInfo">
        <div class="info-row"><span class="info-label">Giorni Completati:</span><span class="info-value" id="infoCompleted">0 / 36</span></div>
        <div class="info-row"><span class="info-label">Giorni Rimanenti:</span><span class="info-value" id="infoRemaining">36</span></div>
        <div class="info-row"><span class="info-label">Data Fine Stimata:</span><span class="info-value" id="infoEndDate">--</span></div>
        <div class="progress-visual"><div class="progress-visual-fill" id="progressVisual" style="width: 0%">0%</div></div>
        <div class="view-mantra" id="viewMantra">
            <div class="view-mantra-label">MANTRA</div>
            <div class="view-mantra-text" id="viewMantraText">--</div>
        </div>
        <div class="view-affirmation" id="viewAffirmation" style="display: none;">
            <div class="view-affirmation-label">AFFERMAZIONE</div>
            <div class="view-affirmation-text" id="viewAffirmationText">--</div>
        </div>
    </div>
    
    <div class="day-info" id="dayInfo">
        <h2>VIBRAZIONI OGGI</h2>
        <div class="vibration-count" id="todayVibrations">0</div>
        <div class="vibration-label">volte il mantra</div>
    </div>
    
    <div class="mantra-section" id="mantraSection">
        <div class="mantra-text" id="mantraText">MANTRA</div>
        <div class="mantra-pronunciation" id="mantraPronunciation"></div>
    </div>
    
    <div class="counter-section" id="vibrationSection">
        <div class="counter-display">
            <div class="counter-number" id="vibCounterDisplay">0</div>
            <span class="vibration-label">di <span id="vibCounterTotal">0</span> vibrazioni</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="vibProgressFill" style="width: 0%"></div></div>
        <div class="avg-time" id="avgTimeText">Media: -- sec/rep</div>
        <div class="message" id="vibMessage"></div>
        <div class="counter-buttons">
            <button class="btn btn-add" id="btnVibAdd1">+1</button>
            <button class="btn btn-add" id="btnVibAdd5">+5</button>
            <button class="btn btn-add" id="btnVibAdd10">+10</button>
            <button class="btn btn-vibra" id="btnVibMain">VIBRA</button>
        </div>
        <div class="extra-controls">
            <button class="ctrl-btn" id="btnHistory">Storico</button>
            <button class="ctrl-btn" id="btnCorrect">Correggi</button>
        </div>
        <div class="settings-row">
            <span>Suoni</span>
            <label class="toggle"><input type="checkbox" id="soundToggle" checked><span class="toggle-slider"></span></label>
        </div>
    </div>
    
    <div class="affirmation-section" id="affirmationSection">
        <div class="affirmation-title">AFFERMAZIONI</div>
        <div class="affirmation-text" id="affirmationText">Affermazione</div>
        <div class="counter-display">
            <div class="counter-number" id="affCounterDisplay">0</div>
            <span class="vibration-label">di <span id="affCounterTotal">0</span> ripetizioni</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="affProgressFill" style="width: 0%"></div></div>
        <div class="message" id="affMessage"></div>
        <div class="counter-buttons">
            <button class="btn btn-add" id="btnAffAdd1">+1</button>
            <button class="btn btn-add" id="btnAffAdd5">+5</button>
            <button class="btn btn-add" id="btnAffAdd10">+10</button>
            <button class="btn btn-vibra" id="btnAffMain">RECITA</button>
            <button class="btn btn-save" id="btnAffSave">SALVA E CHIUDI</button>
        </div>
    </div>
    
    <div class="admin-section" id="adminSection">
        <button class="btn-admin-reset" id="btnAdminReset">RESET ADMIN (Test)</button>
    </div>
    
    <div id="saveSection" style="display: none; padding: 0 10px;">
        <button class="btn btn-save" id="btnSave" style="width: 100%;">SALVA E CHIUDI</button>
    </div>
    
    <div id="closeSection" style="display: none; padding: 10px;">
        <button class="btn btn-close" id="btnClose">CHIUDI</button>
    </div>
    
    <div class="completed-overlay" id="completedOverlay">
        <div class="completed-icon">&#10022;</div>
        <div class="completed-text">GIORNO COMPLETATO!</div>
        <button class="close-btn" id="btnOverlayClose">Salva e Chiudi</button>
    </div>
    
    <div class="warning-popup" id="warningPopup">
        <div class="warning-box">
            <div class="icon">&#9888;</div>
            <div class="title">Click troppo veloce!</div>
            <div class="msg" id="warningMsg">Hai cliccato molto piu velocemente della tua media.</div>
            <div class="detail" id="warningDetail">Media: 5.2s - Questo click: 1.3s</div>
            <div class="btns">
                <button class="btn-cancel" id="btnWarningCancel">Annulla</button>
                <button class="btn-confirm" id="btnWarningConfirm">Conferma</button>
            </div>
        </div>
    </div>
    
    <div class="history-popup" id="historyPopup">
        <div class="history-box">
            <div class="title">Storico Click</div>
            <div class="history-list" id="historyList"></div>
            <button class="btn btn-vibra" style="margin-top:15px" id="btnHistoryClose">CHIUDI</button>
        </div>
    </div>
    
    <audio id="audio10" preload="auto"></audio>
    <audio id="audio20" preload="auto"></audio>
    <audio id="audio30" preload="auto"></audio>
    <audio id="audio40" preload="auto"></audio>
    <audio id="audio50" preload="auto"></audio>
    <audio id="audio100" preload="auto"></audio>
    <audio id="audioLast" preload="auto"></audio>
    <audio id="audioComplete" preload="auto"></audio>
    
<script>
var GRIDS = {
    saturn: [[4,9,2],[3,5,7],[8,1,6]],
    jupiter: [[4,14,15,1],[9,7,6,12],[5,11,10,8],[16,2,3,13]],
    mars: [[11,24,7,20,3],[4,12,25,8,16],[17,5,13,21,9],[10,18,1,14,22],[23,6,19,2,15]],
    sun: [[6,32,3,34,35,1],[7,11,27,28,8,30],[19,14,16,15,23,24],[18,20,22,21,17,13],[25,29,10,9,26,12],[36,5,33,4,2,31]],
    venus: [[22,47,16,41,10,35,4],[5,23,48,17,42,11,29],[30,6,24,49,18,36,12],[13,31,7,25,43,19,37],[38,14,32,1,26,44,20],[21,39,8,33,2,27,45],[46,15,40,9,34,3,28]],
    mercury: [[8,58,59,5,4,62,63,1],[49,15,14,52,53,11,10,56],[41,23,22,44,45,19,18,48],[32,34,35,29,28,38,39,25],[40,26,27,37,36,30,31,33],[17,47,46,20,21,43,42,24],[9,55,54,12,13,51,50,16],[64,2,3,61,60,6,7,57]],
    moon: [[37,78,29,70,21,62,13,54,5],[6,38,79,30,71,22,63,14,46],[47,7,39,80,31,72,23,55,15],[16,48,8,40,81,32,64,24,56],[57,17,49,9,41,73,33,65,25],[26,58,18,50,1,42,74,34,66],[67,27,59,10,51,2,43,75,35],[36,68,19,60,11,52,3,44,76],[77,28,69,20,61,12,53,4,45]]
};

var PLANETS_INFO = {
    saturn: { symbol: "\u2644", name: "SATURNO", days: 15 },
    jupiter: { symbol: "\u2643", name: "GIOVE", days: 16 },
    mars: { symbol: "\u2642", name: "MARTE", days: 25 },
    sun: { symbol: "\u2609", name: "SOLE", days: 36 },
    venus: { symbol: "\u2640", name: "VENERE", days: 49 },
    mercury: { symbol: "\u263F", name: "MERCURIO", days: 64 },
    moon: { symbol: "\u263D", name: "LUNA", days: 81 }
};

var PLANET_HOURS = { 
    sun:{s:'\u2609',n:'Sole',c:'c-sun'}, 
    moon:{s:'\u263D',n:'Luna',c:'c-moon'}, 
    mars:{s:'\u2642',n:'Marte',c:'c-mars'}, 
    mercury:{s:'\u263F',n:'Mercurio',c:'c-mercury'}, 
    jupiter:{s:'\u2643',n:'Giove',c:'c-jupiter'}, 
    venus:{s:'\u2640',n:'Venere',c:'c-venus'}, 
    saturn:{s:'\u2644',n:'Saturno',c:'c-saturn'} 
};
var SEQ = ['saturn','jupiter','mars','sun','venus','mercury','moon'];
var RULERS = {0:'moon',1:'mars',2:'mercury',3:'jupiter',4:'venus',5:'saturn',6:'sun'};

var state = {
    phase: "vibrations",
    vibCount: 0,
    vibTotal: 100,
    affCount: 0,
    affTotal: 0,
    planet: "sun",
    day: 1,
    completed: 0,
    direction: "material",
    workId: "",
    audioUrl: "",
    lang: "it",
    sound: true,
    viewOnly: false,
    mantra: "",
    affirmation: "",
    isAdmin: false,
    lat: 41.9028,
    lon: 12.4964,
    tz: 1
};

// ANTI-CLICK SYSTEM - Conta le AZIONI non i singoli click
var actionHistory = [];
var lastActionTime = null;
var pendingAction = null;
var MIN_ACTIONS_FOR_AVG = 5;  // Ridotto a 5 azioni
var THRESHOLD_FACTOR = 0.4;
var startPlanetHour = null;
var startTime = Date.now();

function sunTimesMin(lat,lon,doy,tz) {
    var latRad=lat*Math.PI/180,dec=-23.45*Math.cos(2*Math.PI/365*(doy+10)),decRad=dec*Math.PI/180,B=2*Math.PI/365*(doy-81),eot=9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B);
    var cosH=(Math.cos(90.833*Math.PI/180)-Math.sin(latRad)*Math.sin(decRad))/(Math.cos(latRad)*Math.cos(decRad));
    cosH=Math.max(-1,Math.min(1,cosH));
    var H=Math.acos(cosH)*180/Math.PI,noon=720-(lon*4)-eot;
    return {sr:noon-(H*4)+(tz*60),ss:noon+(H*4)+(tz*60)};
}

function getCurrentPlanetaryHour() {
    var now=new Date(),doy=Math.floor((now-new Date(now.getFullYear(),0,0))/86400000),nowMin=now.getHours()*60+now.getMinutes(),dow=now.getDay();
    var times=sunTimesMin(state.lat,state.lon,doy,state.tz);
    var nextTimes=sunTimesMin(state.lat,state.lon,doy+1,state.tz);
    var pyDay=(dow+6)%7,ri=SEQ.indexOf(RULERS[pyDay]);
    var hourIndex;
    if(nowMin>=times.sr&&nowMin<times.ss){
        hourIndex=Math.floor((nowMin-times.sr)/((times.ss-times.sr)/12));
    }else{
        var hourLen=((nextTimes.sr+1440)-times.ss)/12;
        hourIndex=(nowMin>=times.ss?Math.floor((nowMin-times.ss)/hourLen):Math.floor((nowMin+1440-times.ss)/hourLen))+12;
    }
    return SEQ[(ri+hourIndex)%7];
}

function updatePlanetHourDisplay() {
    if (!startPlanetHour) startPlanetHour = getCurrentPlanetaryHour();
    var p = PLANET_HOURS[startPlanetHour];
    document.getElementById('startPlanetHour').innerHTML = '<span class="'+p.c+'">'+p.s+' '+p.n+'</span>';
}

function getAverageActionTime() {
    if(actionHistory.length < MIN_ACTIONS_FOR_AVG) return null;
    var deltas = actionHistory.filter(function(a){return a.delta > 0;}).map(function(a){return a.delta;});
    if(deltas.length < MIN_ACTIONS_FOR_AVG) return null;
    var sum = 0;
    for(var i=0; i<deltas.length; i++) sum += deltas[i];
    return sum/deltas.length;
}

function updateAvgDisplay() {
    var a = getAverageActionTime();
    var el = document.getElementById('avgTimeText');
    var remaining = MIN_ACTIONS_FOR_AVG - actionHistory.length;
    if(a) {
        el.textContent = 'Media: '+a.toFixed(1)+' sec/azione';
    } else if(remaining > 0) {
        el.textContent = 'Media: calcolo tra '+remaining+' azioni';
    } else {
        el.textContent = 'Media: --';
    }
}

function showWarning(avg, actionTime) {
    document.getElementById('warningMsg').textContent = 'Hai agito molto piu velocemente della tua media.';
    document.getElementById('warningDetail').textContent = 'Media: '+avg.toFixed(1)+'s - Questa azione: '+actionTime.toFixed(1)+'s';
    document.getElementById('warningPopup').className = 'warning-popup show';
    if(navigator.vibrate) navigator.vibrate([200,100,200,100,200]);
}

function hideWarning() {
    document.getElementById('warningPopup').className = 'warning-popup';
}

function cancelAction() {
    pendingAction = null;
    hideWarning();
}

function confirmAction() {
    if(pendingAction) {
        applyVibration(pendingAction.amount, pendingAction.timestamp, pendingAction.delta, true);
        pendingAction = null;
    }
    hideWarning();
}

function showHistory() {
    var list = document.getElementById('historyList');
    list.innerHTML = '';
    if(actionHistory.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#888;padding:20px">Nessuna azione registrata</div>';
    } else {
        for(var i=0; i<actionHistory.length; i++) {
            var a = actionHistory[i];
            var div = document.createElement('div');
            div.className = 'history-item' + (a.confirmed ? ' warning' : '');
            var t = new Date(a.timestamp).toTimeString().slice(0,8);
            var dt = a.delta > 0 ? '+'+a.delta.toFixed(1)+'s' : '-';
            var warn = a.confirmed ? ' [!]' : '';
            div.innerHTML = '<span class="rep">+'+a.amount+' (tot:'+a.totalAfter+')</span><span class="time">'+t+'</span><span class="delta">'+dt+warn+'</span>';
            list.appendChild(div);
        }
    }
    document.getElementById('historyPopup').className = 'history-popup show';
}

function hideHistory() {
    document.getElementById('historyPopup').className = 'history-popup';
}

function getMaterialPath(size) {
    var path = [];
    for (var col = size - 1; col >= 0; col--) {
        var colFromRight = (size - 1) - col;
        if (colFromRight % 2 === 0) {
            for (var row = 0; row < size; row++) path.push([row, col]);
        } else {
            for (var row = size - 1; row >= 0; row--) path.push([row, col]);
        }
    }
    return path;
}

function getSpiritualPath(size) {
    var path = [];
    for (var col = 0; col < size; col++) {
        if (col % 2 === 0) {
            for (var row = size - 1; row >= 0; row--) path.push([row, col]);
        } else {
            for (var row = 0; row < size; row++) path.push([row, col]);
        }
    }
    return path;
}

function applyVibration(amount, timestamp, delta, confirmed) {
    var left = state.vibTotal - state.vibCount;
    var actualAmount = Math.min(amount, left);
    
    state.vibCount += actualAmount;
    
    // Registra l'AZIONE (non i singoli click)
    actionHistory.push({
        amount: actualAmount,
        totalAfter: state.vibCount,
        timestamp: timestamp || Date.now(),
        delta: delta,
        confirmed: confirmed || false
    });
    
    updateVibrationUI();
    updateAvgDisplay();
    checkMilestone(state.vibCount);
    
    if (state.vibCount >= state.vibTotal) {
        if (state.affTotal > 0) {
            switchToAffirmations();
        } else {
            showComplete();
        }
    }
}

function addVibration(amount) {
    if (state.viewOnly) return;
    if (state.vibCount >= state.vibTotal) return;
    
    var now = Date.now();
    var delta = lastActionTime ? (now - lastActionTime) / 1000 : 0;
    var avg = getAverageActionTime();
    
    // Check anti-click per tutte le azioni
    if (avg && delta > 0 && delta < avg * THRESHOLD_FACTOR) {
        pendingAction = { amount: amount, timestamp: now, delta: delta };
        showWarning(avg, delta);
        return;
    }
    
    lastActionTime = now;
    applyVibration(amount, now, delta, false);
}

function correctVibration() {
    if (state.vibCount > 0 && actionHistory.length > 0) {
        var lastAction = actionHistory.pop();
        state.vibCount -= lastAction.amount;
        if (state.vibCount < 0) state.vibCount = 0;
        updateVibrationUI();
        updateAvgDisplay();
    }
}

function switchToAffirmations() {
    state.phase = "affirmations";
    document.getElementById("step1").className = "step completed";
    document.getElementById("step2").className = "step active";
    document.getElementById("vibrationSection").style.display = "none";
    document.getElementById("affirmationSection").style.display = "block";
    document.getElementById("saveSection").style.display = "none";
}

function addAffirmation(amount) {
    if (state.viewOnly) return;
    var left = state.affTotal - state.affCount;
    var add = Math.min(amount, left);
    state.affCount += add;
    updateAffirmationUI();
    
    if (state.affCount >= state.affTotal) {
        showComplete();
    }
}

function checkMilestone(count) {
    if (!state.sound) return;
    if (count === state.vibTotal - 1) {
        playAudio("audioLast");
    } else if (count % 100 === 0 && count > 0) {
        playAudio("audio100");
    } else if (count % 50 === 0 && count > 0) {
        playAudio("audio50");
    } else if (count % 40 === 0 && count > 0) {
        playAudio("audio40");
    } else if (count % 30 === 0 && count > 0) {
        playAudio("audio30");
    } else if (count % 20 === 0 && count > 0) {
        playAudio("audio20");
    } else if (count % 10 === 0 && count > 0) {
        playAudio("audio10");
    }
}

function updateVibrationUI() {
    document.getElementById("vibCounterDisplay").textContent = state.vibCount;
    document.getElementById("vibCounterTotal").textContent = state.vibTotal;
    var pct = Math.round((state.vibCount / state.vibTotal) * 100);
    document.getElementById("vibProgressFill").style.width = pct + "%";
    
    var left = state.vibTotal - state.vibCount;
    var msg = document.getElementById("vibMessage");
    if (left === 0) {
        msg.textContent = state.affTotal > 0 ? "Vibrazioni complete! Ora le affermazioni..." : "COMPLETATO";
    } else if (left === 1) {
        msg.textContent = "ULTIMA!";
    } else if (left <= 5) {
        msg.textContent = "ULTIME " + left + "!";
    } else {
        msg.textContent = "";
    }
    
    var btn5 = document.getElementById("btnVibAdd5");
    var btn10 = document.getElementById("btnVibAdd10");
    btn5.disabled = left < 5;
    btn5.style.opacity = left < 5 ? "0.4" : "1";
    btn10.disabled = left < 10;
    btn10.style.opacity = left < 10 ? "0.4" : "1";
}

function updateAffirmationUI() {
    document.getElementById("affCounterDisplay").textContent = state.affCount;
    document.getElementById("affCounterTotal").textContent = state.affTotal;
    var pct = Math.round((state.affCount / state.affTotal) * 100);
    document.getElementById("affProgressFill").style.width = pct + "%";
    
    var left = state.affTotal - state.affCount;
    var msg = document.getElementById("affMessage");
    if (left === 0) {
        msg.textContent = "COMPLETATO";
    } else if (left === 1) {
        msg.textContent = "ULTIMA!";
    } else if (left <= 5) {
        msg.textContent = "ULTIME " + left + "!";
    } else {
        msg.textContent = "";
    }
    
    var btn5 = document.getElementById("btnAffAdd5");
    var btn10 = document.getElementById("btnAffAdd10");
    btn5.disabled = left < 5;
    btn5.style.opacity = left < 5 ? "0.4" : "1";
    btn10.disabled = left < 10;
    btn10.style.opacity = left < 10 ? "0.4" : "1";
}

function playAudio(id) {
    var a = document.getElementById(id);
    if (a && a.src) {
        a.currentTime = 0;
        a.play().catch(function(e) { console.log("[AUDIO] Error:", e); });
    }
}

function showComplete() {
    if (state.sound) playAudio("audioComplete");
    document.getElementById("completedOverlay").className = "completed-overlay show";
}

function saveAndClose() {
    var elapsed = Math.floor((Date.now() - startTime) / 1000);
    var data = {
        action: "counter_complete",
        work_id: state.workId,
        vibrations: state.vibCount,
        affirmations: state.affCount,
        total_vibrations: state.vibTotal,
        total_affirmations: state.affTotal,
        planetary_hour: startPlanetHour,
        duration_seconds: elapsed
    };
    console.log("[SQUARE] Saving:", JSON.stringify(data));
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.sendData(JSON.stringify(data));
    } else {
        alert("Dati: " + JSON.stringify(data));
    }
}

function closeWebApp() {
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.close();
    }
}

function adminReset() {
    if (confirm('ADMIN: Vuoi resettare completamente questo contatore?')) {
        state.vibCount = 0;
        state.affCount = 0;
        actionHistory = [];
        lastActionTime = null;
        updateVibrationUI();
        updateAffirmationUI();
        updateAvgDisplay();
        alert('Reset completato!');
    }
}

function loadAudio() {
    if (!state.audioUrl) return;
    var base = state.audioUrl + "/" + state.lang + "/";
    var milestones = [10, 20, 30, 40, 50, 100];
    for (var i = 0; i < milestones.length; i++) {
        var el = document.getElementById("audio" + milestones[i]);
        if (el) el.src = base + milestones[i] + ".mp3";
    }
    var elLast = document.getElementById("audioLast");
    if (elLast) elLast.src = base + "last.mp3";
    var elComp = document.getElementById("audioComplete");
    if (elComp) elComp.src = base + "complete.mp3";
}

function buildGrid() {
    var grid = GRIDS[state.planet];
    if (!grid) return;
    var size = grid.length;
    var container = document.getElementById("squareGrid");
    container.innerHTML = "";
    var maxWidth = Math.min(window.innerWidth - 40, 350);
    var cellSize = Math.floor((maxWidth - 16 - (size - 1) * 2) / size);
    container.style.gridTemplateColumns = "repeat(" + size + ", " + cellSize + "px)";
    container.style.gridTemplateRows = "repeat(" + size + ", " + cellSize + "px)";
    
    var path = state.direction === "material" ? getMaterialPath(size) : getSpiritualPath(size);
    var posMap = {};
    for (var i = 0; i < path.length; i++) {
        posMap[path[i][0] + "," + path[i][1]] = i;
    }
    
    for (var r = 0; r < size; r++) {
        for (var c = 0; c < size; c++) {
            var cell = document.createElement("div");
            cell.className = "cell";
            cell.textContent = grid[r][c];
            cell.style.fontSize = (cellSize * 0.4) + "px";
            var posIdx = posMap[r + "," + c];
            if (posIdx !== undefined) {
                if (state.viewOnly) {
                    if (posIdx < state.completed - 1) {
                        cell.className = "cell completed";
                    } else if (posIdx === state.completed - 1) {
                        cell.className = "cell completed-today";
                    }
                } else {
                    if (posIdx < state.completed) {
                        cell.className = "cell completed";
                    } else if (posIdx === state.completed) {
                        cell.className = "cell current";
                    }
                }
            }
            container.appendChild(cell);
        }
    }
}

function setupViewOnlyMode(planetInfo) {
    document.getElementById("viewOnlyBanner").style.display = "block";
    document.getElementById("completedDayNum").textContent = state.completed;
    document.getElementById("viewOnlyInfo").style.display = "block";
    document.getElementById("stepIndicator").style.display = "none";
    document.getElementById("dayInfo").style.display = "none";
    document.getElementById("mantraSection").style.display = "none";
    document.getElementById("vibrationSection").style.display = "none";
    document.getElementById("affirmationSection").style.display = "none";
    document.getElementById("saveSection").style.display = "none";
    document.getElementById("closeSection").style.display = "block";
    document.getElementById("planetHourBar").style.display = "none";
    
    var totalDays = planetInfo.days;
    var remaining = totalDays - state.completed;
    var pctDone = Math.round((state.completed / totalDays) * 100);
    document.getElementById("infoCompleted").textContent = state.completed + " / " + totalDays;
    document.getElementById("infoRemaining").textContent = remaining;
    document.getElementById("progressVisual").style.width = pctDone + "%";
    document.getElementById("progressVisual").textContent = pctDone + "%";
    
    var endDate = new Date();
    endDate.setDate(endDate.getDate() + remaining);
    document.getElementById("infoEndDate").textContent = endDate.toLocaleDateString('it-IT');
    
    if (state.mantra) {
        document.getElementById("viewMantraText").textContent = state.mantra;
    }
    if (state.affirmation) {
        document.getElementById("viewAffirmation").style.display = "block";
        document.getElementById("viewAffirmationText").textContent = '"' + state.affirmation + '"';
    }
}

function init() {
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
    }
    
    var params = new URLSearchParams(window.location.search);
    state.planet = params.get("planet") || "sun";
    state.day = parseInt(params.get("day")) || 1;
    state.completed = parseInt(params.get("completed")) || 0;
    state.direction = params.get("direction") || "material";
    state.vibTotal = parseInt(params.get("vibrations")) || 100;
    state.affTotal = parseInt(params.get("affirmations")) || 0;
    state.workId = params.get("work_id") || "";
    state.audioUrl = params.get("audio_url") || "";
    state.lang = params.get("lang") || "it";
    state.viewOnly = params.get("view_only") === "true";
    state.isAdmin = params.get("is_admin") === "1";
    state.lat = parseFloat(params.get("lat")) || 41.9028;
    state.lon = parseFloat(params.get("lon")) || 12.4964;
    state.tz = parseFloat(params.get("tz")) || 1;
    
    var soundParam = params.get("sound");
    if (soundParam !== null) {
        state.sound = soundParam !== "false";
        document.getElementById("soundToggle").checked = state.sound;
    }
    
    var affText = params.get("affirmation") || "";
    var mantra = params.get("mantra") || "";
    var pron = params.get("pronunciation") || "";
    try { if (affText) affText = decodeURIComponent(affText); } catch(e) {}
    try { if (mantra) mantra = decodeURIComponent(mantra); } catch(e) {}
    try { if (pron) pron = decodeURIComponent(pron); } catch(e) {}
    
    state.mantra = mantra;
    state.affirmation = affText;
    
    var planetInfo = PLANETS_INFO[state.planet] || PLANETS_INFO.sun;
    document.getElementById("planetSymbol").textContent = planetInfo.symbol;
    document.getElementById("squareTitle").textContent = "QUADRATO " + planetInfo.name;
    document.getElementById("currentDay").textContent = state.day;
    document.getElementById("totalDays").textContent = planetInfo.days;
    document.getElementById("todayVibrations").textContent = state.vibTotal;
    document.getElementById("vibCounterTotal").textContent = state.vibTotal;
    document.getElementById("mantraText").textContent = mantra || "MANTRA";
    if (pron) document.getElementById("mantraPronunciation").textContent = "(" + pron + ")";
    
    if (affText) {
        document.getElementById("affirmationText").textContent = '"' + affText + '"';
        document.getElementById("affCounterTotal").textContent = state.affTotal;
    }
    
    if (state.isAdmin) {
        document.getElementById("adminSection").className = "admin-section show";
    }
    
    updatePlanetHourDisplay();
    
    if (state.viewOnly) {
        setupViewOnlyMode(planetInfo);
    } else {
        if (state.affTotal <= 0) {
            document.getElementById("step2").style.display = "none";
        }
        document.getElementById("saveSection").style.display = "block";
        loadAudio();
        updateVibrationUI();
        updateAvgDisplay();
    }
    
    buildGrid();
    
    document.getElementById("btnVibAdd1").onclick = function() { addVibration(1); };
    document.getElementById("btnVibAdd5").onclick = function() { addVibration(5); };
    document.getElementById("btnVibAdd10").onclick = function() { addVibration(10); };
    document.getElementById("btnVibMain").onclick = function() { addVibration(1); };
    
    document.getElementById("btnAffAdd1").onclick = function() { addAffirmation(1); };
    document.getElementById("btnAffAdd5").onclick = function() { addAffirmation(5); };
    document.getElementById("btnAffAdd10").onclick = function() { addAffirmation(10); };
    document.getElementById("btnAffMain").onclick = function() { addAffirmation(1); };
    document.getElementById("btnAffSave").onclick = saveAndClose;
    
    document.getElementById("btnSave").onclick = saveAndClose;
    document.getElementById("btnClose").onclick = closeWebApp;
    document.getElementById("btnOverlayClose").onclick = saveAndClose;
    
    document.getElementById("btnHistory").onclick = showHistory;
    document.getElementById("btnHistoryClose").onclick = hideHistory;
    document.getElementById("btnCorrect").onclick = correctVibration;
    
    document.getElementById("btnWarningCancel").onclick = cancelAction;
    document.getElementById("btnWarningConfirm").onclick = confirmAction;
    
    document.getElementById("btnAdminReset").onclick = adminReset;
    
    document.getElementById("soundToggle").onchange = function() {
        state.sound = this.checked;
    };
}

init();
</script>
</body>
</html>
