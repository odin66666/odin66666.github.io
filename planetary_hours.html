<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ore Planetarie</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --gold: #d4af37;
      --gold-dim: #b8962e;
      --text: #e8e8e8;
      --text-dim: #888;
      --sun: #ffd700;
      --moon: #c0c0c0;
      --mars: #ff4444;
      --mercury: #8b4513;
      --jupiter: #ff8c00;
      --venus: #90ee90;
      --saturn: #4a4a4a;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      padding: 12px;
    }
    
    .container { max-width: 500px; margin: 0 auto; }
    
    .header {
      text-align: center;
      padding: 16px 0;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
      margin-bottom: 16px;
    }
    .header h1 { font-size: 20px; color: var(--gold); }
    .header .location { font-size: 13px; color: var(--text-dim); margin-top: 6px; }
    .header .date { font-size: 14px; color: var(--text); margin-top: 4px; }
    
    .current-banner {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
      border: 1px solid var(--gold);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      text-align: center;
    }
    .current-banner .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--gold-dim); margin-bottom: 8px; }
    .current-banner .planet-row { display: flex; align-items: center; justify-content: center; gap: 12px; }
    .current-banner .planet-symbol { font-size: 36px; }
    .current-banner .planet-info { text-align: left; }
    .current-banner .planet-name { font-size: 22px; font-weight: bold; }
    .current-banner .planet-time { font-size: 13px; color: var(--text-dim); }
    .current-banner .countdown { margin-top: 10px; font-size: 14px; color: var(--gold); }
    .current-banner .countdown span { font-weight: bold; font-size: 18px; }
    
    .toggle-container { display: flex; background: var(--bg-card); border-radius: 10px; padding: 4px; margin-bottom: 12px; }
    .toggle-btn {
      flex: 1; padding: 10px; border: none; background: transparent;
      color: var(--text-dim); font-size: 14px; font-weight: 500;
      cursor: pointer; border-radius: 8px; transition: all 0.3s;
    }
    .toggle-btn.active { background: rgba(212, 175, 55, 0.2); color: var(--gold); }
    
    .hours-grid { display: flex; flex-direction: column; gap: 6px; }
    
    .hour-row {
      display: grid;
      grid-template-columns: 36px 40px 1fr 70px 70px;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-card);
      border-radius: 10px;
      gap: 8px;
    }
    .hour-row.current {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.08));
      border: 1px solid var(--gold);
    }
    .hour-row.past { opacity: 0.5; }
    
    .hour-num { font-size: 14px; font-weight: bold; color: var(--text-dim); text-align: center; }
    .hour-row.current .hour-num { color: var(--gold); }
    .planet-symbol-small { font-size: 22px; text-align: center; }
    .planet-name-small { font-size: 14px; font-weight: 500; }
    .hour-time { font-size: 13px; color: var(--text-dim); text-align: center; font-family: monospace; }
    .hour-row.current .hour-time { color: var(--text); }
    
    .planet-sun { color: var(--sun); }
    .planet-moon { color: var(--moon); }
    .planet-mars { color: var(--mars); }
    .planet-mercury { color: var(--mercury); }
    .planet-jupiter { color: var(--jupiter); }
    .planet-venus { color: var(--venus); }
    .planet-saturn { color: var(--saturn); }
    
    .sun-info { display: flex; justify-content: space-around; background: var(--bg-card); border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .sun-info-item { text-align: center; }
    .sun-info-item .icon { font-size: 20px; margin-bottom: 4px; }
    .sun-info-item .time { font-size: 16px; font-weight: bold; }
    .sun-info-item .label { font-size: 11px; color: var(--text-dim); }
    
    .day-ruler { text-align: center; padding: 10px; background: var(--bg-card); border-radius: 10px; margin-bottom: 12px; }
    .day-ruler .label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
    .day-ruler .planet { font-size: 18px; font-weight: bold; margin-top: 4px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container" id="app">Caricamento...</div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }
    
    // Leggi parametri URL
    const params = new URLSearchParams(window.location.search);
    const CITY_NAME = params.get('city') || 'Roma';
    const LAT = parseFloat(params.get('lat')) || 41.9028;
    const LON = parseFloat(params.get('lon')) || 12.4964;
    const TZ = parseFloat(params.get('tz')) || 1;
    
    // STATO PERSISTENTE
    let currentView = 'day';
    
    const PLANETS = {
      sun: { symbol: '‚òâ', name: 'Sole', color: 'planet-sun' },
      moon: { symbol: '‚òΩ', name: 'Luna', color: 'planet-moon' },
      mars: { symbol: '‚ôÇ', name: 'Marte', color: 'planet-mars' },
      mercury: { symbol: '‚òø', name: 'Mercurio', color: 'planet-mercury' },
      jupiter: { symbol: '‚ôÉ', name: 'Giove', color: 'planet-jupiter' },
      venus: { symbol: '‚ôÄ', name: 'Venere', color: 'planet-venus' },
      saturn: { symbol: '‚ôÑ', name: 'Saturno', color: 'planet-saturn' }
    };
    
    const CHALDEAN = ['saturn', 'jupiter', 'mars', 'sun', 'venus', 'mercury', 'moon'];
    const DAY_RULERS = { 0: 'moon', 1: 'mars', 2: 'mercury', 3: 'jupiter', 4: 'venus', 5: 'saturn', 6: 'sun' };
    
    function calcSunTimes(lat, lon, date, tz) {
      const doy = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
      const latRad = lat * Math.PI / 180;
      const dec = -23.45 * Math.cos(2 * Math.PI / 365 * (doy + 10));
      const decRad = dec * Math.PI / 180;
      const B = 2 * Math.PI / 365 * (doy - 81);
      const eot = 9.87 * Math.sin(2 * B) - 7.53 * Math.cos(B) - 1.5 * Math.sin(B);
      const zen = 90.833 * Math.PI / 180;
      let cosH = (Math.cos(zen) - Math.sin(latRad) * Math.sin(decRad)) / (Math.cos(latRad) * Math.cos(decRad));
      cosH = Math.max(-1, Math.min(1, cosH));
      const H = Math.acos(cosH) * 180 / Math.PI;
      const noon = 720 - (lon * 4) - eot;
      
      const sr = new Date(date); sr.setHours(0,0,0,0); sr.setMinutes(noon - H*4 + tz*60);
      const ss = new Date(date); ss.setHours(0,0,0,0); ss.setMinutes(noon + H*4 + tz*60);
      return { sunrise: sr, sunset: ss };
    }
    
    function calcHours(lat, lon, date, tz) {
      const { sunrise, sunset } = calcSunTimes(lat, lon, date, tz);
      const tom = new Date(date); tom.setDate(tom.getDate() + 1);
      const { sunrise: nextSr } = calcSunTimes(lat, lon, tom, tz);
      
      const dayLen = (sunset - sunrise) / 12;
      const nightLen = (nextSr - sunset) / 12;
      const wd = (date.getDay() + 6) % 7;
      const ruler = DAY_RULERS[wd];
      const ri = CHALDEAN.indexOf(ruler);
      
      const hours = [];
      let t = new Date(sunrise);
      for (let i = 0; i < 12; i++) {
        const p = CHALDEAN[(ri + i) % 7];
        const e = new Date(t.getTime() + dayLen);
        hours.push({ num: i+1, planet: p, start: new Date(t), end: e, isDay: true });
        t = e;
      }
      t = new Date(sunset);
      for (let i = 0; i < 12; i++) {
        const p = CHALDEAN[(ri + 12 + i) % 7];
        const e = new Date(t.getTime() + nightLen);
        hours.push({ num: i+13, planet: p, start: new Date(t), end: e, isDay: false });
        t = e;
      }
      return { hours, sunrise, sunset, ruler };
    }
    
    function fmt(d) { return d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }); }
    
    function getCurrent(hours, now) {
      for (const h of hours) if (now >= h.start && now < h.end) return h;
      return null;
    }
    
    function renderRow(h, now, cur) {
      const p = PLANETS[h.planet];
      const isCur = cur && h.num === cur.num;
      const isPast = now >= h.end;
      let cls = 'hour-row';
      if (isCur) cls += ' current';
      else if (isPast) cls += ' past';
      return `<div class="${cls}">
        <div class="hour-num">${h.num}</div>
        <div class="planet-symbol-small ${p.color}">${p.symbol}</div>
        <div class="planet-name-small ${p.color}">${p.name}</div>
        <div class="hour-time">${fmt(h.start)}</div>
        <div class="hour-time">${fmt(h.end)}</div>
      </div>`;
    }
    
    function renderAll() {
      const now = new Date();
      const d = calcHours(LAT, LON, now, TZ);
      const cur = getCurrent(d.hours, now);
      const day = d.hours.filter(h => h.isDay);
      const night = d.hours.filter(h => !h.isDay);
      const pi = cur ? PLANETS[cur.planet] : null;
      const ri = PLANETS[d.ruler];
      
      const rem = cur ? Math.floor((cur.end - now) / 1000) : 0;
      const mins = Math.floor(rem / 60);
      const secs = rem % 60;
      
      const dayAct = currentView === 'day' ? 'active' : '';
      const nightAct = currentView === 'night' ? 'active' : '';
      const dayHide = currentView === 'day' ? '' : 'hidden';
      const nightHide = currentView === 'night' ? '' : 'hidden';
      
      let html = `
        <div class="header">
          <h1>‚è∞ ORE PLANETARIE</h1>
          <div class="location">üìç ${CITY_NAME}</div>
          <div class="date">${now.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
        </div>
        <div class="day-ruler">
          <div class="label">Giorno di</div>
          <div class="planet ${ri.color}">${ri.symbol} ${ri.name}</div>
        </div>
        <div class="sun-info">
          <div class="sun-info-item"><div class="icon">üåÖ</div><div class="time">${fmt(d.sunrise)}</div><div class="label">Alba</div></div>
          <div class="sun-info-item"><div class="icon">üåá</div><div class="time">${fmt(d.sunset)}</div><div class="label">Tramonto</div></div>
        </div>`;
      
      if (cur && pi) {
        html += `
        <div class="current-banner">
          <div class="label">Ora Corrente</div>
          <div class="planet-row">
            <span class="planet-symbol ${pi.color}">${pi.symbol}</span>
            <div class="planet-info">
              <div class="planet-name ${pi.color}">${pi.name}</div>
              <div class="planet-time">${fmt(cur.start)} - ${fmt(cur.end)}</div>
            </div>
          </div>
          <div class="countdown" id="cd">Termina tra <span>${mins}m ${secs}s</span></div>
        </div>`;
      }
      
      html += `
        <div class="toggle-container">
          <button class="toggle-btn ${dayAct}" onclick="showDay()">‚òÄÔ∏è Diurne (1-12)</button>
          <button class="toggle-btn ${nightAct}" onclick="showNight()">üåô Notturne (13-24)</button>
        </div>
        <div class="hours-grid ${dayHide}" id="hDay">${day.map(h => renderRow(h, now, cur)).join('')}</div>
        <div class="hours-grid ${nightHide}" id="hNight">${night.map(h => renderRow(h, now, cur)).join('')}</div>`;
      
      document.getElementById('app').innerHTML = html;
    }
    
    function updateCD() {
      const now = new Date();
      const d = calcHours(LAT, LON, now, TZ);
      const cur = getCurrent(d.hours, now);
      const el = document.getElementById('cd');
      if (el && cur) {
        const rem = Math.floor((cur.end - now) / 1000);
        el.innerHTML = `Termina tra <span>${Math.floor(rem/60)}m ${rem%60}s</span>`;
      }
    }
    
    function showDay() {
      currentView = 'day';
      document.getElementById('hDay').classList.remove('hidden');
      document.getElementById('hNight').classList.add('hidden');
      document.querySelectorAll('.toggle-btn').forEach((b,i) => {
        b.classList.toggle('active', i === 0);
      });
    }
    
    function showNight() {
      currentView = 'night';
      document.getElementById('hDay').classList.add('hidden');
      document.getElementById('hNight').classList.remove('hidden');
      document.querySelectorAll('.toggle-btn').forEach((b,i) => {
        b.classList.toggle('active', i === 1);
      });
    }
    
    renderAll();
    setInterval(updateCD, 1000);
  </script>
</body>
</html>
