<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Meditazione Chakra</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(to bottom, #0f0a1a, #1a0a2e, #0f0a1a);
      min-height: 100vh;
      color: #e9d5ff;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes glow { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.15); opacity: 0.9; } }
    .glow { animation: glow 2.5s ease-in-out infinite; }
    .pulse { animation: pulse 1.5s ease-in-out infinite; }
    
    .container { max-width: 400px; margin: 0 auto; padding: 16px; }
    .card { background: rgba(88, 28, 135, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .card-dark { background: rgba(0, 0, 0, 0.4); }
    .btn { padding: 12px 24px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: all 0.2s; font-size: 14px; }
    .btn-primary { background: linear-gradient(to right, #7c3aed, #4f46e5); color: white; }
    .btn-secondary { background: #374151; color: white; }
    .btn-selected { background: #7c3aed; box-shadow: 0 0 0 2px #a78bfa; }
    
    .text-center { text-align: center; }
    .text-xs { font-size: 12px; }
    .text-sm { font-size: 14px; }
    .text-lg { font-size: 18px; }
    .text-xl { font-size: 20px; }
    .text-2xl { font-size: 24px; }
    .text-4xl { font-size: 36px; }
    .text-6xl { font-size: 60px; }
    .font-bold { font-weight: bold; }
    .font-mono { font-family: monospace; }
    
    .mb-1 { margin-bottom: 4px; } .mb-2 { margin-bottom: 8px; } .mb-3 { margin-bottom: 12px; } .mb-4 { margin-bottom: 16px; }
    .mt-1 { margin-top: 4px; } .mt-2 { margin-top: 8px; }
    .p-2 { padding: 8px; } .p-3 { padding: 12px; } .p-4 { padding: 16px; }
    
    .flex { display: flex; } .flex-col { flex-direction: column; } .flex-wrap { flex-wrap: wrap; } .flex-1 { flex: 1; }
    .items-center { align-items: center; } .justify-center { justify-content: center; } .justify-between { justify-content: space-between; }
    .gap-1 { gap: 4px; } .gap-2 { gap: 8px; } .gap-4 { gap: 16px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .rounded-full { border-radius: 9999px; }
    .w-full { width: 100%; }
    .min-h-screen { min-height: 100vh; }
    
    .text-purple-100 { color: #f3e8ff; } .text-purple-300 { color: #d8b4fe; }
    .text-yellow-300 { color: #fde047; } .text-yellow-400 { color: #facc15; }
    .text-green-400 { color: #4ade80; } .text-red-400 { color: #f87171; } .text-blue-300 { color: #93c5fd; }
    .bg-purple-600 { background-color: #7c3aed; } .bg-gray-700 { background-color: #374151; }
    
    .chakra-dot { width: 16px; height: 16px; border-radius: 50%; transition: all 0.3s; }
    .chakra-dot-sm { width: 10px; height: 10px; border-radius: 50%; }
    
    .warning-box { background: rgba(234, 179, 8, 0.2); border-radius: 8px; padding: 12px; }
    .success-box { background: rgba(34, 197, 94, 0.2); border-radius: 8px; padding: 12px; }
    .info-box { background: rgba(59, 130, 246, 0.2); border-radius: 8px; padding: 12px; }
    
    .figure-container { position: relative; width: 90px; height: 180px; }
    .figure-img { width: 100%; height: 100%; object-fit: contain; opacity: 0.85; }
    .chakra-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // TELEGRAM WEBAPP API
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    // URL PARAMS
    const urlParams = new URLSearchParams(window.location.search);
    const PARAM_USER_ID = urlParams.get('user_id') || '';
    const PARAM_CATEGORY = urlParams.get('category') || 'necronomicon';
    const PARAM_REPS = parseInt(urlParams.get('reps')) || 7;
    const PARAM_IMAGE_URL = urlParams.get('image_url') ? decodeURIComponent(urlParams.get('image_url')) : null;
    const PARAM_WORK_ID = urlParams.get('work_id') || null;

    // AUDIO
    const Audio = {
      ctx: null,
      init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); return this.ctx; },
      tone(f, d, t = 'sine', v = 0.3) {
        try {
          const c = this.init(), o = c.createOscillator(), g = c.createGain();
          o.connect(g); g.connect(c.destination); o.frequency.value = f; o.type = t;
          g.gain.setValueAtTime(v, c.currentTime); g.gain.exponentialRampToValueAtTime(0.01, c.currentTime + d);
          o.start(c.currentTime); o.stop(c.currentTime + d);
        } catch(e) {}
      },
      preLast() { this.tone(880, 0.2, 'sine', 0.2); },
      last() { this.tone(523, 0.5); setTimeout(() => this.tone(659, 0.5, 'sine', 0.3), 100); setTimeout(() => this.tone(784, 0.8, 'sine', 0.35), 200); },
      chakraDone() { this.tone(523, 0.15, 'triangle', 0.3); setTimeout(() => this.tone(659, 0.15, 'triangle', 0.3), 150); setTimeout(() => this.tone(784, 0.3, 'triangle', 0.4), 300); },
      complete() { [523, 587, 659, 698, 784, 880, 988, 1047].forEach((f, i) => setTimeout(() => this.tone(f, 0.4, 'sine', 0.25), i * 150)); },
      ding() { this.tone(698, 0.3, 'sine', 0.25); }
    };

    // SUNRISE
    const getSunrise = (d = new Date()) => {
      const doy = Math.floor((d - new Date(d.getFullYear(), 0, 0)) / 86400000);
      const h = 6 + Math.cos((doy - 172) * 2 * Math.PI / 365) * 1.5;
      const s = new Date(d); s.setHours(Math.floor(h), Math.round((h % 1) * 60), 0, 0);
      return s;
    };
    const getNextSunrise = () => {
      const now = new Date(), today = getSunrise(now);
      if (now < today) return today;
      const tmr = new Date(now); tmr.setDate(tmr.getDate() + 1);
      return getSunrise(tmr);
    };

    // CHAKRAS
    const CHAKRAS = [
      { id: 'crown', name: 'Corona', skt: 'Sahasrara', color: '#8B5CF6', day: 'Gio', y: 5,
        vib: { necronomicon: { w: 'MARDUK', p: 'M-M-M-AH-AH-AH-R-R-R-DH-DH-DH-OO-OO-OO-K-K-K' }, traditional: { w: 'AUM', p: 'AH-AH-AH-UU-UU-UU-MM-MM-MM' }, runic: { w: 'ING', p: 'E-E-E-E-E-N-N-N-G-G-G-G' }, sanskrit: { w: 'MAUM', p: 'M-M-AH-AH-AH-U-U-U-U-M-M-M-M' } }, note: 'Lilith' },
      { id: 'sixth', name: '6¬∞ Chakra', skt: 'Ajna', color: '#4F46E5', day: 'Lun', y: 12,
        vib: { necronomicon: { w: 'NANNA', p: 'N-N-N-AH-AH-AH-N-N-N-N-N-AH-AH-AH' }, traditional: { w: 'AUM', p: 'AH-AH-AH-UU-UU-UU-MM-MM-MM' }, runic: { w: 'DAGAZ', p: 'D-D-AH-AH-G-G-AH-AH-Z-Z-Z-Z' }, sanskrit: { w: 'THAUM', p: 'TH-TH-AH-AH-AH-U-U-U-U-M-M-M-M' } }, note: null },
      { id: 'throat', name: 'Gola', skt: 'Vishuddha', color: '#06B6D4', day: 'Mer', y: 28,
        vib: { necronomicon: { w: 'NEBO', p: 'N-N-AY-AY-AY-B-B-B-OH-OH-OH' }, traditional: { w: 'HAM', p: 'HH-HH-AH-AH-AH-MM-MM-MM' }, runic: { w: 'ANSUZ', p: 'AH-AH-N-N-S-S-OO-OO-Z-Z-Z' }, sanskrit: { w: 'HAUM', p: 'HH-AH-AH-AH-U-U-U-U-M-M-M-M' } }, note: null },
      { id: 'heart', name: 'Cuore', skt: 'Anahata', color: '#22C55E', day: 'Ven', y: 38,
        vib: { necronomicon: { w: 'INANNA', p: 'E-E-N-N-AH-AH-N-N-N-AH-AH-AH' }, traditional: { w: 'YAM', p: 'Y-Y-AH-AH-AH-MM-MM-MM' }, runic: { w: 'BERKANO', p: 'B-B-AY-AY-R-R-K-K-AH-AH-N-N-OH-OH' }, sanskrit: { w: 'YAUM', p: 'Y-Y-AH-AH-AH-U-U-U-U-M-M-M-M' } }, note: null },
      { id: 'solar', name: 'Solare', skt: 'Manipura', color: '#EAB308', day: 'Dom', y: 48,
        vib: { necronomicon: { w: 'UTU', p: 'OO-OO-OO-T-T-T-OO-OO-OO' }, traditional: { w: 'RAM', p: 'R-R-AH-AH-AH-MM-MM-MM' }, runic: { w: 'SOWILO', p: 'S-S-S-OH-OH-W-W-EE-EE-L-L-OH-OH' }, sanskrit: { w: 'RAUM', p: 'R-R-AH-AH-AH-U-U-U-U-M-M-M-M' } }, note: 'Azazel' },
      { id: 'sacral', name: 'Sacrale', skt: 'Svadhisthana', color: '#F97316', day: 'Mar', y: 58,
        vib: { necronomicon: { w: 'NERGAL', p: 'N-N-AY-AY-R-R-G-G-AH-AH-L-L-L' }, traditional: { w: 'VAM', p: 'V-V-AH-AH-AH-MM-MM-MM' }, runic: { w: 'KENAZ', p: 'K-K-AY-AY-N-N-AH-AH-Z-Z-Z-Z' }, sanskrit: { w: 'VAUM', p: 'V-V-AH-AH-AH-U-U-U-U-M-M-M-M' } }, note: null },
      { id: 'root', name: 'Base', skt: 'Muladhara', color: '#EF4444', day: 'Sab', y: 72,
        vib: { necronomicon: { w: 'NINIB', p: 'N-N-EE-EE-N-N-EE-EE-B-B-B' }, traditional: { w: 'LAM', p: 'L-L-AH-AH-AH-MM-MM-MM' }, runic: { w: 'URUZ', p: 'OO-OO-R-R-OO-OO-Z-Z-Z-Z' }, sanskrit: { w: 'LAUM', p: 'L-L-AH-AH-AH-U-U-U-U-M-M-M-M' } }, note: 'Satana' }
    ];
    const CATS = [
      { id: 'necronomicon', name: 'Necronomicon', lvl: 'Nuovi/Esperti', icon: 'üìú' },
      { id: 'traditional', name: 'Tradizionale', lvl: 'Nuovi/Esperti', icon: 'üïâÔ∏è' },
      { id: 'runic', name: 'Runico', lvl: 'Intermedio', icon: '·ö±' },
      { id: 'sanskrit', name: 'Sanscrito', lvl: 'SOLO Esperti', icon: 'üî•' }
    ];
    const AFF = "TUTTI I MIEI CHAKRA SONO COMPLETAMENTE E TOTALMENTE POTENZIATI IN MANIERA SANA E POSITIVA PER ME ORA E PER SEMPRE";
    const AFF_REPS = 3;

    const fmtTime = s => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
    const fmtDur = s => s < 60 ? `${s}s` : `${Math.floor(s/60)}m ${s%60}s`;
    const fmtCD = ms => { if (ms <= 0) return '00:00:00'; const h = Math.floor(ms/3600000), m = Math.floor((ms%3600000)/60000), s = Math.floor((ms%60000)/1000); return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; };

    // FIGURE
    const Figure = ({ active, done, img }) => {
      if (img) {
        return (
          <div className="figure-container">
            <img src={img} alt="" className="figure-img" onError={(e) => e.target.style.display = 'none'} />
            <svg viewBox="0 0 100 100" className="chakra-overlay">
              {CHAKRAS.map(c => {
                const on = active === c.id, ok = done.includes(c.id);
                return (
                  <g key={c.id}>
                    {on && <circle cx="50" cy={c.y} r="10" fill={c.color} opacity="0.5" className="glow" />}
                    <circle cx="50" cy={c.y} r={on ? 6 : 4} fill={on || ok ? c.color : 'rgba(255,255,255,0.2)'} stroke={on ? '#fff' : ok ? c.color : 'rgba(255,255,255,0.3)'} strokeWidth={on ? 2 : 1} style={{ filter: on ? `drop-shadow(0 0 8px ${c.color})` : 'none' }} />
                    {ok && !on && <text x="50" y={c.y + 2} textAnchor="middle" fill="#fff" fontSize="5" fontWeight="bold">‚úì</text>}
                  </g>
                );
              })}
            </svg>
          </div>
        );
      }
      return (
        <svg viewBox="0 0 100 200" style={{ width: 80, height: 160 }}>
          <defs><linearGradient id="bg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stopColor="#374151"/><stop offset="100%" stopColor="#1f2937"/></linearGradient></defs>
          <ellipse cx="50" cy="20" rx="15" ry="18" fill="url(#bg)" stroke="#4b5563"/><rect x="44" y="36" width="12" height="12" fill="url(#bg)"/>
          <path d="M30 48 L70 48 L65 120 L35 120 Z" fill="url(#bg)" stroke="#4b5563"/><path d="M30 50 L15 90 L20 92 L32 55" fill="url(#bg)"/><path d="M70 50 L85 90 L80 92 L68 55" fill="url(#bg)"/>
          <path d="M38 120 L35 180 L42 180 L48 125" fill="url(#bg)"/><path d="M62 120 L65 180 L58 180 L52 125" fill="url(#bg)"/>
          {CHAKRAS.map(c => { const on = active === c.id, ok = done.includes(c.id), yy = c.y * 1.8 + 10; return (
            <g key={c.id}>{on && <circle cx="50" cy={yy} r="12" fill={c.color} opacity="0.4" className="glow"/>}
            <circle cx="50" cy={yy} r={on ? 7 : 4} fill={on || ok ? c.color : '#374151'} stroke={on ? '#fff' : ok ? c.color : '#4b5563'} strokeWidth={on ? 2 : 1} style={{ filter: on ? `drop-shadow(0 0 6px ${c.color})` : 'none' }}/>
            {ok && !on && <text x="50" y={yy + 2} textAnchor="middle" fill="#fff" fontSize="5" fontWeight="bold">‚úì</text>}</g>
          );})}
        </svg>
      );
    };

    // SEND TO BOT & CLOSE
    const sendToBot = data => { if (tg) tg.sendData(JSON.stringify(data)); };
    const closeApp = () => { if (tg) tg.close(); else window.close(); };

    // APP
    function App() {
      const [scr, setScr] = React.useState('home');
      const [cat, setCat] = React.useState(PARAM_CATEGORY);
      const [reps, setReps] = React.useState(PARAM_REPS);
      const [idx, setIdx] = React.useState(0);
      const [cnt, setCnt] = React.useState(0);
      const [done, setDone] = React.useState([]);
      const [sec, setSec] = React.useState(0);
      const [trans, setTrans] = React.useState(false);
      const [snd, setSnd] = React.useState(true);
      const [sess, setSess] = React.useState(null);
      const [affCnt, setAffCnt] = React.useState(0);
      const [nextSun, setNextSun] = React.useState(getNextSunrise());
      const [cd, setCd] = React.useState(0);

      React.useEffect(() => { let i; if (scr === 'med') i = setInterval(() => setSec(s => s + 1), 1000); return () => clearInterval(i); }, [scr]);
      React.useEffect(() => { const i = setInterval(() => { const d = nextSun.getTime() - Date.now(); setCd(d > 0 ? d : 0); if (d <= 0) setNextSun(getNextSunrise()); }, 1000); return () => clearInterval(i); }, [nextSun]);

      const ch = CHAKRAS[idx], vb = ch?.vib[cat] || ch?.vib.necronomicon;

      const tap = () => {
        if (trans) return;
        const n = cnt + 1; setCnt(n);
        if (snd) { if (n === reps - 1) Audio.preLast(); else if (n === reps) Audio.last(); }
        if (n >= reps) {
          setTrans(true); setDone(p => [...p, ch.id]);
          setTimeout(() => {
            if (idx < 6) { if (snd) Audio.chakraDone(); setIdx(i => i + 1); setCnt(0); setTrans(false); }
            else { if (snd) Audio.complete(); setScr('aff'); }
          }, 1000);
        }
      };

      const affTap = () => {
        if (affCnt < AFF_REPS) {
          const n = affCnt + 1; setAffCnt(n);
          if (snd) { if (n === AFF_REPS) Audio.complete(); else Audio.ding(); }
          if (n >= AFF_REPS) setTimeout(() => {
            const data = { type: 'chakra_complete', user_id: PARAM_USER_ID, work_id: PARAM_WORK_ID, duration: sec, total_reps: reps * 7 + AFF_REPS, category: cat, reps_per_chakra: reps, completed_at: new Date().toISOString() };
            setSess(data); sendToBot(data); setScr('sum');
          }, 800);
        }
      };

      const start = () => { setScr('med'); setIdx(0); setCnt(0); setDone([]); setSec(0); setTrans(false); setAffCnt(0); };

      // HOME
      if (scr === 'home') return (
        <div className="container" style={{ paddingTop: 20 }}>
          <div className="text-center mb-4">
            <div className="flex justify-center gap-1 mb-3">{CHAKRAS.map(c => <div key={c.id} className="chakra-dot" style={{ backgroundColor: c.color, boxShadow: `0 0 8px ${c.color}66` }}/>)}</div>
            <h1 className="text-xl font-bold text-purple-100">Meditazione Chakra</h1>
            <p className="text-xs text-purple-300 mt-2">Potenziamento completo dei 7 chakra</p>
          </div>
          <div className="flex justify-end gap-2 mb-4">
            <button onClick={() => setSnd(!snd)} className={`btn rounded-full ${snd ? 'bg-purple-600' : 'bg-gray-700'}`} style={{ padding: '8px 12px' }}>{snd ? 'üîä' : 'üîá'}</button>
          </div>
          <div className="card mb-4">
            <h2 className="font-bold text-sm text-purple-100 mb-3">üìú CATEGORIA</h2>
            <div className="grid-2">{CATS.map(c => <button key={c.id} onClick={() => setCat(c.id)} className={`btn text-left ${cat === c.id ? 'btn-selected' : 'btn-secondary'}`} style={{ padding: 12 }}><div className="font-bold text-sm">{c.icon} {c.name}</div><div className="text-xs text-purple-300">{c.lvl}</div></button>)}</div>
          </div>
          <div className="card mb-4">
            <h2 className="font-bold text-sm text-purple-100 mb-3">üî¢ RIPETIZIONI</h2>
            <div className="flex gap-2 flex-wrap">{[3, 7, 9, 18, 36, 54, 108].map(n => <button key={n} onClick={() => setReps(n)} className={`btn ${reps === n ? 'btn-selected' : 'btn-secondary'}`} style={{ padding: '8px 16px' }}>{n}</button>)}</div>
            <p className="text-xs text-purple-300 mt-2">Totale: {reps * 7} + {AFF_REPS} aff.</p>
          </div>
          <div className="card mb-4">
            <h2 className="font-bold text-sm text-purple-100 mb-2">üëÅÔ∏è ANTEPRIMA</h2>
            <div className="flex items-center gap-4">
              <Figure active="crown" done={[]} img={PARAM_IMAGE_URL} />
              <div><p className="text-xs text-purple-300">Primo:</p><p className="font-bold text-purple-100">{CHAKRAS[0].name}</p><p className="text-sm mt-1" style={{ color: CHAKRAS[0].color }}>{CHAKRAS[0].vib[cat]?.w}</p></div>
            </div>
          </div>
          <button onClick={start} className="btn btn-primary w-full" style={{ padding: 16, fontSize: 16 }}>üßò INIZIA</button>
          <div className="warning-box mt-4">
            <p className="text-yellow-300 text-xs text-center">‚ö†Ô∏è Medita entro 36h per mantenere il ciclo</p>
            <p className="text-yellow-400 text-xs text-center mt-1 font-bold">üåÖ Prossima alba: {fmtCD(cd)}</p>
          </div>
        </div>
      );

      // MEDITATION
      if (scr === 'med') {
        const pre = cnt === reps - 2, last = cnt === reps - 1;
        return (
          <div className="min-h-screen flex flex-col" onClick={tap} style={{ cursor: 'pointer' }}>
            <div className="flex justify-between items-center p-3">
              <span className="text-xs text-purple-300">‚è±Ô∏è {fmtTime(sec)}</span>
              <span className="text-xs font-bold text-purple-100">Chakra {idx + 1}/7</span>
              <button onClick={e => { e.stopPropagation(); setScr('home'); }} className="text-xs text-red-400">‚úï</button>
            </div>
            <div className="flex-1 flex flex-col items-center justify-center" style={{ padding: '0 16px' }}>
              <div className="mb-4"><Figure active={ch.id} done={done} img={PARAM_IMAGE_URL} /></div>
              <div className="text-center mb-3">
                <div className="text-6xl font-bold" style={{ color: ch.color, textShadow: `0 0 20px ${ch.color}` }}>{cnt}</div>
                <div className="text-sm text-purple-300">di {reps}</div>
              </div>
              {pre && !trans && <p className="text-yellow-400 text-sm mb-1 pulse">‚ö° Penultima!</p>}
              {last && !trans && <p className="text-green-400 text-sm mb-1 font-bold pulse">üéØ ULTIMA!</p>}
              {trans && <p className="text-green-400 font-bold pulse mb-1">‚úì Completato!</p>}
              <div className="text-center mb-2"><h2 className="text-lg font-bold text-purple-100">{ch.name}</h2><p className="text-xs text-purple-300">{ch.skt} ‚Ä¢ {ch.day}</p></div>
              <div className="card card-dark text-center mb-2" style={{ maxWidth: 300, width: '100%' }}>
                <div className="text-xl font-bold mb-1" style={{ color: ch.color }}>{vb.w}</div>
                <div className="text-xs font-mono text-purple-300">{vb.p}</div>
              </div>
              {ch.note && <p className="text-yellow-300 text-xs text-center" style={{ opacity: 0.7 }}>‚ú® {ch.note}</p>}
              {!trans && !pre && !last && <p className="text-xs text-purple-300 mt-2 pulse">Tocca per vibrare</p>}
            </div>
            <div className="flex justify-center gap-1" style={{ paddingBottom: 12 }}>{CHAKRAS.map((c, i) => <div key={c.id} className="chakra-dot-sm" style={{ backgroundColor: done.includes(c.id) || i === idx ? c.color : '#374151', boxShadow: i === idx ? '0 0 0 2px rgba(255,255,255,0.3)' : 'none' }}/>)}</div>
          </div>
        );
      }

      // AFFIRMATION
      if (scr === 'aff') return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4" onClick={affTap} style={{ cursor: 'pointer' }}>
          <div className="text-center" style={{ maxWidth: 350 }}>
            <div className="text-4xl mb-4">‚ú®</div>
            <h2 className="text-lg font-bold text-purple-100 mb-4">AFFERMAZIONE</h2>
            <div className="card card-dark p-4 mb-4"><p className="text-sm text-purple-100" style={{ lineHeight: 1.6 }}>"{AFF}"</p></div>
            <div className="mb-4"><div className="text-4xl font-bold text-purple-100">{affCnt}</div><div className="text-sm text-purple-300">di {AFF_REPS}</div></div>
            <div className="flex justify-center gap-2 mb-4">{[...Array(AFF_REPS)].map((_, i) => <div key={i} className="chakra-dot" style={{ backgroundColor: i < affCnt ? '#facc15' : '#374151', boxShadow: i < affCnt ? '0 0 10px #facc15' : 'none' }}/>)}</div>
            <p className="text-xs text-purple-300 pulse">Tocca per ripetere</p>
          </div>
        </div>
      );

      // SUMMARY
      if (scr === 'sum' && sess) {
        const dl = new Date(Date.now() + 36 * 3600000);
        return (
          <div className="container" style={{ paddingTop: 20 }}>
            <div className="text-center mb-4">
              <div className="flex justify-center gap-1 mb-3">{CHAKRAS.map((c, i) => <div key={c.id} className="chakra-dot" style={{ backgroundColor: c.color, boxShadow: `0 0 10px ${c.color}66`, animation: `pulse 1.5s ease-in-out infinite`, animationDelay: `${i * 0.1}s` }}/>)}</div>
              <div className="text-4xl mb-2">‚ú®</div>
              <h1 className="text-xl font-bold text-purple-100">Completata!</h1>
              <p className="text-xs text-purple-300 mt-1">Ciclo mantenuto</p>
            </div>
            <div className="card mb-4">
              <h2 className="font-bold text-sm text-purple-100 mb-3 text-center">üìä RIEPILOGO</h2>
              <div className="grid-2 mb-3">
                <div className="card card-dark text-center p-3"><div className="text-2xl">‚è±Ô∏è</div><div className="font-bold text-purple-100">{fmtDur(sess.duration)}</div><div className="text-xs text-purple-300">Durata</div></div>
                <div className="card card-dark text-center p-3"><div className="text-2xl">üî¢</div><div className="font-bold text-purple-100">{sess.total_reps}</div><div className="text-xs text-purple-300">Vibrazioni</div></div>
              </div>
              <div className="card card-dark p-2">
                <div className="flex justify-between text-xs mb-1"><span className="text-purple-300">Categoria:</span><span className="text-purple-100">{CATS.find(c => c.id === sess.category)?.icon} {CATS.find(c => c.id === sess.category)?.name}</span></div>
                <div className="flex justify-between text-xs"><span className="text-purple-300">Reps/chakra:</span><span className="text-purple-100">{sess.reps_per_chakra}</span></div>
              </div>
            </div>
            <div className="success-box mb-4">
              <p className="text-green-400 text-sm text-center font-bold">‚úì Ciclo OK!</p>
              <p className="text-xs text-center mt-1" style={{ color: '#86efac' }}>üåÖ Prossima: dopo l'alba</p>
              <p className="text-xs text-center mt-1" style={{ color: '#86efac' }}>‚è∞ Deadline: {dl.toLocaleString('it-IT', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' })}</p>
            </div>
            <div className="info-box mb-4"><p className="text-blue-300 text-xs text-center">üì± Sincronizzato con bot</p></div>
            <button onClick={closeApp} className="btn bg-purple-600 w-full text-white font-bold" style={{ padding: 14 }}>‚úì CHIUDI</button>
          </div>
        );
      }
      return null;
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
