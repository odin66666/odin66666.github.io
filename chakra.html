<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Meditazione Chakra</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(to bottom, #0f0a1a, #1a0a2e, #0f0a1a); min-height: 100vh; color: #e9d5ff; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes glow { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.15); opacity: 0.9; } }
    .glow { animation: glow 2.5s ease-in-out infinite; }
    .pulse { animation: pulse 1.5s ease-in-out infinite; }
    .container { max-width: 400px; margin: 0 auto; padding: 16px; }
    .card { background: rgba(88, 28, 135, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .card-dark { background: rgba(0, 0, 0, 0.4); }
    .btn { padding: 12px 24px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: all 0.2s; font-size: 14px; }
    .btn-primary { background: linear-gradient(to right, #7c3aed, #4f46e5); color: white; }
    .btn-secondary { background: #374151; color: white; }
    .btn-selected { background: #7c3aed; box-shadow: 0 0 0 2px #a78bfa; }
    .text-center { text-align: center; }
    .text-xs { font-size: 12px; } .text-sm { font-size: 14px; } .text-lg { font-size: 18px; } .text-xl { font-size: 20px; }
    .text-2xl { font-size: 24px; } .text-4xl { font-size: 36px; } .text-6xl { font-size: 60px; }
    .font-bold { font-weight: bold; } .font-mono { font-family: monospace; }
    .mb-1 { margin-bottom: 4px; } .mb-2 { margin-bottom: 8px; } .mb-3 { margin-bottom: 12px; } .mb-4 { margin-bottom: 16px; }
    .mt-1 { margin-top: 4px; } .mt-2 { margin-top: 8px; }
    .p-2 { padding: 8px; } .p-3 { padding: 12px; } .p-4 { padding: 16px; }
    .flex { display: flex; } .flex-col { flex-direction: column; } .flex-wrap { flex-wrap: wrap; } .flex-1 { flex: 1; }
    .items-center { align-items: center; } .justify-center { justify-content: center; } .justify-between { justify-content: space-between; }
    .gap-1 { gap: 4px; } .gap-2 { gap: 8px; } .gap-4 { gap: 16px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .rounded-full { border-radius: 9999px; }
    .w-full { width: 100%; }
    .min-h-screen { min-height: 100vh; }
    .text-purple-100 { color: #f3e8ff; } .text-purple-300 { color: #d8b4fe; }
    .text-yellow-300 { color: #fde047; } .text-yellow-400 { color: #facc15; }
    .text-green-400 { color: #4ade80; } .text-red-400 { color: #f87171; } .text-blue-300 { color: #93c5fd; }
    .bg-purple-600 { background-color: #7c3aed; } .bg-gray-700 { background-color: #374151; }
    .chakra-dot { width: 16px; height: 16px; border-radius: 50%; transition: all 0.3s; }
    .chakra-dot-sm { width: 10px; height: 10px; border-radius: 50%; }
    .warning-box { background: rgba(234, 179, 8, 0.2); border-radius: 8px; padding: 12px; }
    .success-box { background: rgba(34, 197, 94, 0.2); border-radius: 8px; padding: 12px; }
    .info-box { background: rgba(59, 130, 246, 0.2); border-radius: 8px; padding: 12px; }
    .debug-box { background: rgba(239, 68, 68, 0.4); border: 2px solid #ef4444; border-radius: 8px; padding: 12px; margin: 8px 0; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; }
    .figure-container { position: relative; width: 90px; height: 180px; }
    .figure-img { width: 100%; height: 100%; object-fit: contain; opacity: 0.85; }
    .chakra-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // ==================== DEBUG SYSTEM ====================
    const debugLogs = [];
    const addDebug = (msg) => {
      const time = new Date().toLocaleTimeString();
      const entry = `${time}: ${msg}`;
      debugLogs.unshift(entry);
      console.log(`[CHAKRA] ${entry}`);
      // Update debug panel if exists
      const panel = document.getElementById('debug-content');
      if (panel) panel.innerHTML = debugLogs.slice(0, 20).join('<br>');
    };

    // ==================== TELEGRAM CHECK ====================
    addDebug('Script starting...');
    addDebug(`window.Telegram exists: ${!!window.Telegram}`);
    addDebug(`window.Telegram.WebApp exists: ${!!(window.Telegram && window.Telegram.WebApp)}`);
    
    const tg = window.Telegram?.WebApp;
    
    if (tg) {
      addDebug(`tg.version: ${tg.version}`);
      addDebug(`tg.platform: ${tg.platform}`);
      addDebug(`tg.initData length: ${tg.initData?.length || 0}`);
      addDebug(`tg.initDataUnsafe: ${JSON.stringify(tg.initDataUnsafe || {}).substring(0, 100)}`);
      addDebug(`typeof tg.sendData: ${typeof tg.sendData}`);
      addDebug(`typeof tg.close: ${typeof tg.close}`);
      
      tg.ready();
      addDebug('tg.ready() called');
      tg.expand();
      addDebug('tg.expand() called');
    } else {
      addDebug('ERROR: Telegram WebApp NOT available!');
    }

    // URL PARAMS
    const urlParams = new URLSearchParams(window.location.search);
    const PARAM_USER_ID = urlParams.get('user_id') || '';
    const PARAM_IMAGE_URL = urlParams.get('image_url') ? decodeURIComponent(urlParams.get('image_url')) : null;
    addDebug(`URL user_id: ${PARAM_USER_ID}`);

    // AUDIO
    const Audio = {
      ctx: null,
      init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); return this.ctx; },
      tone(f, d, t = 'sine', v = 0.3) {
        try { const c = this.init(), o = c.createOscillator(), g = c.createGain(); o.connect(g); g.connect(c.destination); o.frequency.value = f; o.type = t; g.gain.setValueAtTime(v, c.currentTime); g.gain.exponentialRampToValueAtTime(0.01, c.currentTime + d); o.start(c.currentTime); o.stop(c.currentTime + d); } catch(e) {}
      },
      preLast() { this.tone(880, 0.2); }, last() { this.tone(523, 0.5); setTimeout(() => this.tone(659, 0.5, 'sine', 0.3), 100); setTimeout(() => this.tone(784, 0.8, 'sine', 0.35), 200); },
      chakraDone() { this.tone(523, 0.15, 'triangle', 0.3); setTimeout(() => this.tone(659, 0.15, 'triangle', 0.3), 150); setTimeout(() => this.tone(784, 0.3, 'triangle', 0.4), 300); },
      complete() { [523, 587, 659, 698, 784, 880, 988, 1047].forEach((f, i) => setTimeout(() => this.tone(f, 0.4, 'sine', 0.25), i * 150)); },
      ding() { this.tone(698, 0.3); }
    };

    // CHAKRAS
    const CHAKRAS = [
      { id: 'crown', name: 'Corona', color: '#8B5CF6', y: 5, vib: { w: 'MARDUK', p: 'M-M-M-AH-R-R-DH-OO-K-K' }, note: 'Lilith' },
      { id: 'sixth', name: '6¬∞ Chakra', color: '#4F46E5', y: 12, vib: { w: 'NANNA', p: 'N-N-AH-N-N-AH' } },
      { id: 'throat', name: 'Gola', color: '#06B6D4', y: 28, vib: { w: 'NEBO', p: 'N-AY-B-OH' } },
      { id: 'heart', name: 'Cuore', color: '#22C55E', y: 38, vib: { w: 'INANNA', p: 'E-N-AH-N-AH' } },
      { id: 'solar', name: 'Solare', color: '#EAB308', y: 48, vib: { w: 'UTU', p: 'OO-T-OO' }, note: 'Azazel' },
      { id: 'sacral', name: 'Sacrale', color: '#F97316', y: 58, vib: { w: 'NERGAL', p: 'N-AY-R-G-AH-L' } },
      { id: 'root', name: 'Base', color: '#EF4444', y: 72, vib: { w: 'NINIB', p: 'N-EE-N-EE-B' }, note: 'Satana' }
    ];
    const AFF = "TUTTI I MIEI CHAKRA SONO COMPLETAMENTE POTENZIATI";
    const AFF_REPS = 3;
    const fmtTime = s => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

    // FIGURE SVG
    const Figure = ({ active, done }) => (
      <svg viewBox="0 0 100 200" style={{ width: 80, height: 160 }}>
        <defs><linearGradient id="bg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stopColor="#374151"/><stop offset="100%" stopColor="#1f2937"/></linearGradient></defs>
        <ellipse cx="50" cy="20" rx="15" ry="18" fill="url(#bg)" stroke="#4b5563"/><rect x="44" y="36" width="12" height="12" fill="url(#bg)"/>
        <path d="M30 48 L70 48 L65 120 L35 120 Z" fill="url(#bg)" stroke="#4b5563"/>
        <path d="M30 50 L15 90 L20 92 L32 55" fill="url(#bg)"/><path d="M70 50 L85 90 L80 92 L68 55" fill="url(#bg)"/>
        <path d="M38 120 L35 180 L42 180 L48 125" fill="url(#bg)"/><path d="M62 120 L65 180 L58 180 L52 125" fill="url(#bg)"/>
        {CHAKRAS.map(c => { const on = active === c.id, ok = done.includes(c.id), yy = c.y * 1.8 + 10; return (
          <g key={c.id}>{on && <circle cx="50" cy={yy} r="12" fill={c.color} opacity="0.4" className="glow"/>}
          <circle cx="50" cy={yy} r={on ? 7 : 4} fill={on || ok ? c.color : '#374151'} stroke={on ? '#fff' : ok ? c.color : '#4b5563'} strokeWidth={on ? 2 : 1} style={{ filter: on ? `drop-shadow(0 0 6px ${c.color})` : 'none' }}/>
          {ok && !on && <text x="50" y={yy + 2} textAnchor="middle" fill="#fff" fontSize="5">‚úì</text>}</g>
        );})}
      </svg>
    );

    // ==================== SYNC FUNCTIONS ====================
    const sendToBot = (data) => {
      addDebug('=== sendToBot CALLED ===');
      addDebug(`Data to send: ${JSON.stringify(data)}`);
      
      if (!tg) {
        addDebug('ERROR: tg is null/undefined');
        return { success: false, error: 'tg not available' };
      }
      
      if (typeof tg.sendData !== 'function') {
        addDebug(`ERROR: tg.sendData is not a function, it is: ${typeof tg.sendData}`);
        return { success: false, error: 'sendData not a function' };
      }
      
      try {
        const jsonStr = JSON.stringify(data);
        addDebug(`Calling tg.sendData with ${jsonStr.length} chars`);
        tg.sendData(jsonStr);
        addDebug('tg.sendData() completed without error');
        return { success: true };
      } catch (err) {
        addDebug(`ERROR in sendData: ${err.message}`);
        return { success: false, error: err.message };
      }
    };

    const closeApp = () => {
      addDebug('=== closeApp CALLED ===');
      if (tg && typeof tg.close === 'function') {
        addDebug('Calling tg.close()');
        tg.close();
      } else {
        addDebug('tg.close not available');
      }
    };

    // ==================== MAIN APP ====================
    function App() {
      const [scr, setScr] = React.useState('home');
      const [reps, setReps] = React.useState(3); // Ridotto per test veloce
      const [idx, setIdx] = React.useState(0);
      const [cnt, setCnt] = React.useState(0);
      const [done, setDone] = React.useState([]);
      const [sec, setSec] = React.useState(0);
      const [trans, setTrans] = React.useState(false);
      const [snd, setSnd] = React.useState(true);
      const [sess, setSess] = React.useState(null);
      const [affCnt, setAffCnt] = React.useState(0);
      const [syncResult, setSyncResult] = React.useState(null);
      const [, forceUpdate] = React.useState(0);

      React.useEffect(() => { let i; if (scr === 'med') i = setInterval(() => setSec(s => s + 1), 1000); return () => clearInterval(i); }, [scr]);
      // Force re-render to update debug
      React.useEffect(() => { const i = setInterval(() => forceUpdate(n => n + 1), 1000); return () => clearInterval(i); }, []);

      const ch = CHAKRAS[idx];

      const tap = () => {
        if (trans) return;
        const n = cnt + 1; setCnt(n);
        if (snd) { if (n === reps - 1) Audio.preLast(); else if (n === reps) Audio.last(); }
        if (n >= reps) {
          setTrans(true); setDone(p => [...p, ch.id]);
          setTimeout(() => {
            if (idx < 6) { if (snd) Audio.chakraDone(); setIdx(i => i + 1); setCnt(0); setTrans(false); }
            else { if (snd) Audio.complete(); setScr('aff'); }
          }, 800);
        }
      };

      const affTap = () => {
        if (affCnt < AFF_REPS) {
          const n = affCnt + 1; setAffCnt(n);
          if (snd) { if (n === AFF_REPS) Audio.complete(); else Audio.ding(); }
          if (n >= AFF_REPS) {
            addDebug('=== MEDITATION COMPLETE ===');
            setTimeout(() => {
              const data = { 
                type: 'chakra_complete', 
                user_id: PARAM_USER_ID, 
                duration: sec, 
                total_reps: reps * 7 + AFF_REPS, 
                category: 'necronomicon', 
                reps_per_chakra: reps, 
                completed_at: new Date().toISOString() 
              };
              addDebug(`Session data prepared: ${JSON.stringify(data)}`);
              setSess(data);
              
              // TRY TO SYNC
              addDebug('Attempting sync...');
              const result = sendToBot(data);
              addDebug(`Sync result: ${JSON.stringify(result)}`);
              setSyncResult(result);
              
              setScr('sum');
            }, 500);
          }
        }
      };

      const start = () => { addDebug('Starting meditation'); setScr('med'); setIdx(0); setCnt(0); setDone([]); setSec(0); setTrans(false); setAffCnt(0); };

      // Debug Panel Component
      const DebugPanel = () => (
        <div className="debug-box">
          <div style={{ color: '#ef4444', fontWeight: 'bold', marginBottom: 8 }}>üîß DEBUG PANEL</div>
          <div style={{ marginBottom: 4 }}>
            <b>Telegram:</b> {tg ? '‚úÖ Available' : '‚ùå NOT Available'}<br/>
            <b>sendData:</b> {tg && typeof tg.sendData === 'function' ? '‚úÖ Function' : '‚ùå NOT Function'}<br/>
            <b>close:</b> {tg && typeof tg.close === 'function' ? '‚úÖ Function' : '‚ùå NOT Function'}<br/>
            <b>initData:</b> {tg?.initData ? `${tg.initData.length} chars` : 'EMPTY'}<br/>
            <b>platform:</b> {tg?.platform || 'unknown'}<br/>
          </div>
          <div style={{ borderTop: '1px solid #ef4444', paddingTop: 4, marginTop: 4 }}>
            <b>Log:</b><br/>
            <div id="debug-content" style={{ fontSize: 10 }}>{debugLogs.slice(0, 15).join('\n')}</div>
          </div>
        </div>
      );

      // HOME
      if (scr === 'home') return (
        <div className="container" style={{ paddingTop: 16 }}>
          <div className="text-center mb-4">
            <div className="flex justify-center gap-1 mb-2">{CHAKRAS.map(c => <div key={c.id} className="chakra-dot" style={{ backgroundColor: c.color }}/>)}</div>
            <h1 className="text-xl font-bold text-purple-100">Meditazione Chakra</h1>
            <p className="text-xs text-purple-300">DEBUG VERSION</p>
          </div>
          
          <DebugPanel />
          
          <div className="card mb-4">
            <h2 className="font-bold text-sm text-purple-100 mb-2">üî¢ RIPETIZIONI (test veloce)</h2>
            <div className="flex gap-2 flex-wrap">{[1, 2, 3].map(n => <button key={n} onClick={() => setReps(n)} className={`btn ${reps === n ? 'btn-selected' : 'btn-secondary'}`} style={{ padding: '8px 16px' }}>{n}</button>)}</div>
          </div>
          
          <button onClick={start} className="btn btn-primary w-full" style={{ padding: 16 }}>üßò INIZIA TEST</button>
        </div>
      );

      // MEDITATION
      if (scr === 'med') {
        return (
          <div className="min-h-screen flex flex-col" onClick={tap} style={{ cursor: 'pointer' }}>
            <div className="flex justify-between items-center p-3">
              <span className="text-xs">‚è±Ô∏è {fmtTime(sec)}</span>
              <span className="text-xs font-bold">Chakra {idx + 1}/7</span>
              <button onClick={e => { e.stopPropagation(); setScr('home'); }} className="text-xs text-red-400">‚úï</button>
            </div>
            <div className="flex-1 flex flex-col items-center justify-center p-4">
              <Figure active={ch.id} done={done} />
              <div className="text-center mb-2">
                <div className="text-6xl font-bold" style={{ color: ch.color }}>{cnt}</div>
                <div className="text-sm text-purple-300">di {reps}</div>
              </div>
              {trans && <p className="text-green-400 font-bold">‚úì Completato!</p>}
              <div className="text-center mb-2"><h2 className="text-lg font-bold">{ch.name}</h2></div>
              <div className="card card-dark text-center" style={{ maxWidth: 280 }}>
                <div className="text-xl font-bold" style={{ color: ch.color }}>{ch.vib.w}</div>
                <div className="text-xs font-mono text-purple-300">{ch.vib.p}</div>
              </div>
              {!trans && <p className="text-xs text-purple-300 mt-4 pulse">Tocca per vibrare</p>}
            </div>
          </div>
        );
      }

      // AFFIRMATION
      if (scr === 'aff') return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4" onClick={affTap} style={{ cursor: 'pointer' }}>
          <div className="text-center" style={{ maxWidth: 320 }}>
            <div className="text-4xl mb-4">‚ú®</div>
            <h2 className="text-lg font-bold mb-4">AFFERMAZIONE</h2>
            <div className="card card-dark p-3 mb-4"><p className="text-sm">"{AFF}"</p></div>
            <div className="text-4xl font-bold mb-2">{affCnt} / {AFF_REPS}</div>
            <p className="text-xs text-purple-300 pulse">Tocca per ripetere</p>
          </div>
        </div>
      );

      // SUMMARY
      if (scr === 'sum') {
        return (
          <div className="container" style={{ paddingTop: 16 }}>
            <div className="text-center mb-4">
              <div className="text-4xl mb-2">‚ú®</div>
              <h1 className="text-xl font-bold">Completata!</h1>
            </div>
            
            <div className="card mb-4">
              <h2 className="font-bold text-sm mb-2 text-center">üìä RIEPILOGO</h2>
              <div className="text-center">
                <p>Durata: {Math.floor(sec/60)}m {sec%60}s</p>
                <p>Vibrazioni: {reps * 7 + AFF_REPS}</p>
              </div>
            </div>
            
            {/* SYNC STATUS */}
            <div className={syncResult?.success ? 'success-box' : 'warning-box'} style={{ marginBottom: 16 }}>
              <p className={`text-sm text-center font-bold ${syncResult?.success ? 'text-green-400' : 'text-red-400'}`}>
                {syncResult?.success ? '‚úÖ SYNC OK!' : `‚ùå SYNC FAILED: ${syncResult?.error || 'unknown'}`}
              </p>
            </div>
            
            <DebugPanel />
            
            <button onClick={closeApp} className="btn bg-purple-600 w-full text-white font-bold mt-4" style={{ padding: 14 }}>
              CHIUDI
            </button>
            
            {/* Manual test buttons */}
            <div className="card mt-4">
              <p className="text-xs text-center mb-2">Test manuali:</p>
              <button onClick={() => { addDebug('Manual sendData test'); const r = sendToBot({test: true}); addDebug(`Result: ${JSON.stringify(r)}`); setSyncResult(r); }} className="btn btn-secondary w-full mb-2">
                Test sendData
              </button>
              <button onClick={() => { addDebug('Manual close test'); closeApp(); }} className="btn btn-secondary w-full">
                Test close
              </button>
            </div>
          </div>
        );
      }
      return null;
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
