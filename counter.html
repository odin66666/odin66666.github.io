<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Contatore Vibrazioni</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cinzel', serif; background: #0a0a12; color: #e8e8e8; min-height: 100vh; padding: 10px; }
        .container { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 10px; }
        .header h1 { font-size: 1.2rem; color: #d4af37; }
        .header .subtitle { font-size: 0.8rem; color: #888; margin-top: 5px; }
        .work-type { font-size: 0.7rem; color: #7b2cbf; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Griglia giorni */
        .days-grid-container { background: #12121f; border-radius: 12px; padding: 12px; margin: 10px 0; border: 1px solid rgba(212, 175, 55, 0.3); }
        .days-grid-title { text-align: center; font-size: 0.8rem; color: #888; margin-bottom: 8px; }
        .days-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; }
        .day-box { width: 24px; height: 24px; border-radius: 4px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #666; }
        .day-box.completed { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .day-box.current { background: linear-gradient(135deg, #d4af37, #c9a227); color: #1a1a1a; animation: pulse 2s infinite; }
        .day-box.completed-today { background: linear-gradient(135deg, #10b981, #d4af37); color: white; border: 2px solid #fff; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .step-indicator { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
        .step { padding: 6px 14px; border-radius: 20px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: #888; }
        .step.active { background: linear-gradient(135deg, #7b2cbf, #d4af37); color: white; }
        .step.completed { background: #10b981; color: white; }
        
        .info-card { background: #12121f; border-radius: 12px; padding: 12px; margin: 10px 0; border: 1px solid rgba(212, 175, 55, 0.3); }
        .info-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.8rem; }
        .info-label { color: #888; }
        .info-value { color: #d4af37; font-weight: bold; }
        
        .rune-display { text-align: center; margin: 10px 0; padding: 10px; background: rgba(123, 44, 191, 0.1); border-radius: 10px; }
        .rune-symbols { font-size: 1.5rem; color: #d4af37; margin-bottom: 5px; letter-spacing: 5px; }
        .rune-names { font-size: 0.75rem; color: #888; }
        
        .vibration-info { background: #12121f; border-radius: 12px; padding: 15px; margin: 10px 0; border: 1px solid rgba(212, 175, 55, 0.3); text-align: center; }
        .vibration-big { font-size: 2.5rem; color: #d4af37; }
        .vibration-label { font-size: 0.8rem; color: #888; }
        
        .card { background: #12121f; border-radius: 12px; padding: 15px; margin: 10px 0; border: 1px solid rgba(123, 44, 191, 0.3); }
        .count-display { text-align: center; margin-bottom: 10px; }
        .count-big { font-size: 3rem; font-weight: bold; color: #d4af37; }
        .count-total { font-size: 0.9rem; color: #888; }
        .progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #7b2cbf, #d4af37); transition: width 0.3s; }
        .message { text-align: center; font-size: 0.9rem; color: #f4d675; min-height: 22px; margin: 8px 0; }
        
        .affirmation-section { background: #12121f; border-radius: 12px; padding: 15px; margin: 10px 0; border: 1px solid rgba(123, 44, 191, 0.3); display: none; }
        .affirmation-title { color: #d4af37; font-size: 0.9rem; text-align: center; margin-bottom: 10px; }
        .affirmation-text { background: rgba(123, 44, 191, 0.15); border-radius: 8px; padding: 12px; font-style: italic; font-size: 0.85rem; border-left: 3px solid #7b2cbf; margin-bottom: 12px; text-align: center; color: #f4d675; }
        
        .buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .btn { padding: 12px; font-size: 1rem; font-weight: bold; font-family: 'Cinzel', serif; border: none; border-radius: 10px; cursor: pointer; color: white; transition: opacity 0.3s; }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { cursor: not-allowed; transform: none; }
        .btn-add { background: linear-gradient(135deg, #7b2cbf, #9d4edd); }
        .btn-main { grid-column: span 3; padding: 15px; font-size: 1.1rem; background: linear-gradient(135deg, #d4af37, #c9a227); color: #1a1a1a; }
        .btn-save { grid-column: span 3; padding: 15px; font-size: 1rem; background: linear-gradient(135deg, #10b981, #059669); margin-top: 10px; }
        .btn-close { width: 100%; padding: 15px; font-size: 1rem; background: #444; margin-top: 10px; }
        
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 0.8rem; color: #888; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px; }
        .toggle { position: relative; width: 40px; height: 22px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.2); border-radius: 22px; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle input:checked + .toggle-slider { background: #d4af37; }
        .toggle input:checked + .toggle-slider:before { transform: translateX(18px); }
        
        .completed-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(212, 175, 55, 0.95), rgba(123, 44, 191, 0.95)); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .completed-overlay.show { display: flex; }
        .completed-icon { font-size: 4rem; margin-bottom: 10px; }
        .completed-text { font-size: 1.5rem; color: #1a1a1a; margin-bottom: 20px; }
        .close-btn { padding: 12px 30px; background: #1a1a1a; color: #d4af37; border: 2px solid #d4af37; border-radius: 25px; font-family: 'Cinzel', serif; font-size: 1rem; cursor: pointer; }
        
        .view-only-banner { background: #10b981; color: white; text-align: center; padding: 10px; border-radius: 10px; margin-bottom: 10px; display: none; font-size: 0.9rem; }
        .progress-visual { background: rgba(255,255,255,0.1); border-radius: 10px; height: 20px; overflow: hidden; margin: 10px 0; }
        .progress-visual-fill { height: 100%; background: linear-gradient(90deg, #10b981, #d4af37); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #1a1a1a; font-weight: bold; }
        
        /* Info planetaria e media */
        .session-info { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(212,175,55,0.1); border-radius: 8px; margin: 8px 0; font-size: 0.7rem; }
        .planetary-hour { color: #d4af37; }
        .moon-sign { color: #9d4edd; }
        .avg-time { color: #888; }
        
        /* Warning popup */
        .warning-popup { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .warning-popup.show { display: flex; }
        .warning-box { background: #1a1a2e; border: 2px solid #ef4444; border-radius: 16px; padding: 20px; max-width: 320px; text-align: center; }
        .warning-icon { font-size: 3rem; margin-bottom: 10px; }
        .warning-title { color: #ef4444; font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; }
        .warning-msg { color: #e8e8e8; font-size: 0.9rem; margin-bottom: 8px; }
        .warning-detail { color: #888; font-size: 0.8rem; margin-bottom: 15px; }
        .warning-btns { display: flex; gap: 10px; justify-content: center; }
        .btn-warn { padding: 10px 20px; border: none; border-radius: 8px; font-family: inherit; cursor: pointer; font-size: 0.9rem; }
        .btn-warn-cancel { background: #333; color: white; }
        .btn-warn-confirm { background: #ef4444; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="work-type" id="workType">LAVORO RUNICO</div>
            <h1 id="title">Lavoro</h1>
            <div class="subtitle">Giorno <span id="currentDay">1</span> di <span id="totalDays">40</span></div>
        </div>
        
        <div class="view-only-banner" id="viewOnlyBanner">‚úÖ GIORNO <span id="completedDayNum">1</span> COMPLETATO</div>
        
        <!-- Griglia giorni visiva -->
        <div class="days-grid-container" id="daysGridContainer">
            <div class="days-grid-title">PROGRESSO: <span id="daysProgress">0/40</span></div>
            <div class="days-grid" id="daysGrid"></div>
        </div>
        
        <!-- Rune display (solo per lavori runici) -->
        <div class="rune-display" id="runeDisplay" style="display: none;">
            <div class="rune-symbols" id="runeSymbols">√°≈°¬†√°≈°¬¢√°≈°¬¶</div>
            <div class="rune-names" id="runeNames">Fehu, Uruz, Thurisaz</div>
        </div>
        
        <div class="step-indicator" id="stepIndicator">
            <div class="step active" id="step1">üìä Vibrazioni</div>
            <div class="step" id="step2">‚úçÔ∏è Affermazioni</div>
        </div>
        
        <!-- Sezione vibrazioni info -->
        <div class="vibration-info" id="vibrationInfo">
            <div class="vibration-big" id="vibrationTarget">40</div>
            <div class="vibration-label">vibrazioni per oggi</div>
        </div>
        
        <!-- Info sessione: ora planetaria, luna e media -->
        <div class="session-info" id="sessionInfo">
            <span class="planetary-hour">ü™ê <span id="planetaryHourText">--</span></span>
            <span class="moon-sign">‚òΩ <span id="moonSignText">--</span></span>
            <span class="avg-time" id="avgTimeText">Media: calcolo...</span>
        </div>
        
        <!-- Counter vibrazioni -->
        <div class="card" id="vibrationSection">
            <div class="count-display">
                <div class="count-big" id="vibCount">0</div>
                <div class="count-total">di <span id="vibTotal">40</span></div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="vibProgress" style="width: 0%"></div></div>
            <div class="message" id="vibMessage"></div>
            <div class="buttons">
                <button class="btn btn-add" id="btnVibAdd1">+1</button>
                <button class="btn btn-add" id="btnVibAdd5">+5</button>
                <button class="btn btn-add" id="btnVibAdd10">+10</button>
                <button class="btn btn-main" id="btnVibMain">‚ö° VIBRA ‚ö°</button>
            </div>
            <div class="settings-row">
                <span>üìä Suoni</span>
                <label class="toggle"><input type="checkbox" id="soundToggle" checked><span class="toggle-slider"></span></label>
            </div>
        </div>
        
        <!-- Sezione affermazioni -->
        <div class="affirmation-section" id="affirmationSection">
            <div class="affirmation-title">‚úçÔ∏è AFFERMAZIONI</div>
            <div class="affirmation-text" id="affirmationText">Affermazione</div>
            <div class="count-display">
                <div class="count-big" id="affCount">0</div>
                <div class="count-total">di <span id="affTotal">0</span></div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="affProgress" style="width: 0%"></div></div>
            <div class="message" id="affMessage"></div>
            <div class="buttons">
                <button class="btn btn-add" id="btnAffAdd1">+1</button>
                <button class="btn btn-add" id="btnAffAdd5">+5</button>
                <button class="btn btn-add" id="btnAffAdd10">+10</button>
                <button class="btn btn-main" id="btnAffMain">‚úçÔ∏è RECITA ‚úçÔ∏è</button>
            </div>
        </div>
        
        <!-- View only info -->
        <div class="info-card" id="viewOnlyInfo" style="display: none;">
            <div class="info-row"><span class="info-label">üìÖ Giorni Completati:</span><span class="info-value" id="infoCompleted">0 / 40</span></div>
            <div class="info-row"><span class="info-label">‚è≥ Giorni Rimanenti:</span><span class="info-value" id="infoRemaining">40</span></div>
            <div class="info-row"><span class="info-label">üèÅ Data Fine Stimata:</span><span class="info-value" id="infoEndDate">--</span></div>
            <div class="progress-visual"><div class="progress-visual-fill" id="progressVisual" style="width: 0%">0%</div></div>
            <div class="affirmation-text" id="viewAffirmation" style="display: none; margin-top: 10px;"></div>
        </div>
        
        <!-- Pulsante salva -->
        <div id="saveSection" style="padding: 0;">
            <button class="btn btn-save" id="btnSave">‚úÖ SALVA E CHIUDI</button>
        </div>
        
        <!-- Pulsante chiudi (view only) -->
        <div id="closeSection" style="display: none;">
            <button class="btn btn-close" id="btnClose">‚Üê CHIUDI</button>
        </div>
    </div>
    
    <div class="completed-overlay" id="completedOverlay">
        <div class="completed-icon">‚úß</div>
        <div class="completed-text">GIORNO COMPLETATO!</div>
        <button class="close-btn" id="btnOverlayClose">Salva e Chiudi</button>
    </div>
    
    <!-- Warning popup anti-click -->
    <div class="warning-popup" id="warningPopup">
        <div class="warning-box">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <div class="warning-title">Click troppo veloce!</div>
            <div class="warning-msg" id="warningMsg">Hai cliccato molto pi√π velocemente della tua media.</div>
            <div class="warning-detail" id="warningDetail">Media: --s - Questo click: --s</div>
            <div class="warning-btns">
                <button class="btn-warn btn-warn-cancel" id="btnWarnCancel">Annulla</button>
                <button class="btn-warn btn-warn-confirm" id="btnWarnConfirm">Conferma</button>
            </div>
        </div>
    </div>
    
    <audio id="audio10" preload="auto"></audio>
    <audio id="audio20" preload="auto"></audio>
    <audio id="audio30" preload="auto"></audio>
    <audio id="audio40" preload="auto"></audio>
    <audio id="audio50" preload="auto"></audio>
    <audio id="audio100" preload="auto"></audio>
    <audio id="audioLast" preload="auto"></audio>
    <audio id="audioComplete" preload="auto"></audio>
    
<script>
var state = {
    phase: "vibrations",
    vibCount: 0,
    vibTotal: 40,
    affCount: 0,
    affTotal: 0,
    day: 1,
    totalDays: 40,
    completed: 0,
    workId: "",
    workType: "rune",
    name: "Lavoro",
    runes: "",
    runeNames: "",
    audioUrl: "",
    lang: "it",
    sound: true,
    viewOnly: false,
    affirmation: ""
};

// ===== RUNE MULTIPLE =====
var RUNES = [];  // Array di {symbol, name, pronunciation, reps}
var currentRuneIndex = 0;
var totalRunesCompleted = 0;

// ===== ANTI-CLICK E ORA PLANETARIA =====
var clickHistory = [];
var lastClickTime = null;
var pendingClick = null;
var MIN_CLICKS_FOR_AVG = 10;
var THRESHOLD_FACTOR = 0.4;

var startPlanetaryHour = null;
var startTimeISO = null;
var currentPlanet = null;
var startMoonSign = null;

var PLANETARY_ORDER = ["saturn", "jupiter", "mars", "sun", "venus", "mercury", "moon"];
var PLANETARY_NAMES = {
    saturn: {symbol: "‚ôÑ", name: "Saturno"},
    jupiter: {symbol: "‚ôÉ", name: "Giove"},
    mars: {symbol: "‚ôÇ", name: "Marte"},
    sun: {symbol: "‚òâ", name: "Sole"},
    venus: {symbol: "‚ôÄ", name: "Venere"},
    mercury: {symbol: "‚òø", name: "Mercurio"},
    moon: {symbol: "‚òΩ", name: "Luna"}
};
var DAY_RULERS = ["sun", "moon", "mars", "mercury", "jupiter", "venus", "saturn"];

var ZODIAC_SIGNS = [
    {name: "Ariete", symbol: "‚ôà"},
    {name: "Toro", symbol: "‚ôâ"},
    {name: "Gemelli", symbol: "‚ôä"},
    {name: "Cancro", symbol: "‚ôã"},
    {name: "Leone", symbol: "‚ôå"},
    {name: "Vergine", symbol: "‚ôç"},
    {name: "Bilancia", symbol: "‚ôé"},
    {name: "Scorpione", symbol: "‚ôè"},
    {name: "Sagittario", symbol: "‚ôê"},
    {name: "Capricorno", symbol: "‚ôë"},
    {name: "Acquario", symbol: "‚ôí"},
    {name: "Pesci", symbol: "‚ôì"}
];

function getMoonSign() {
    // Calcolo semplificato basato su ciclo lunare di ~27.32 giorni attraverso lo zodiaco
    // Ogni segno dura circa 2.28 giorni
    var now = new Date();
    // Epoca di riferimento: 1 Gennaio 2000, Luna in Ariete
    var epoch = new Date(2000, 0, 6, 18, 0, 0);
    var msPerDay = 86400000;
    var daysSinceEpoch = (now - epoch) / msPerDay;
    var lunarCycle = 27.321661;
    var daysPerSign = lunarCycle / 12;
    var positionInCycle = daysSinceEpoch % lunarCycle;
    var signIndex = Math.floor(positionInCycle / daysPerSign) % 12;
    return ZODIAC_SIGNS[signIndex];
}

function getSunTimes(lat, lon, date) {
    var dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
    var latRad = lat * Math.PI / 180;
    var dec = -23.45 * Math.cos(2 * Math.PI / 365 * (dayOfYear + 10));
    var decRad = dec * Math.PI / 180;
    var B = 2 * Math.PI / 365 * (dayOfYear - 81);
    var eot = 9.87 * Math.sin(2 * B) - 7.53 * Math.cos(B) - 1.5 * Math.sin(B);
    var cosH = (Math.cos(90.833 * Math.PI / 180) - Math.sin(latRad) * Math.sin(decRad)) / (Math.cos(latRad) * Math.cos(decRad));
    cosH = Math.max(-1, Math.min(1, cosH));
    var H = Math.acos(cosH) * 180 / Math.PI;
    var noon = 720 - (lon * 4) - eot;
    return { sunrise: (noon - H * 4) / 60, sunset: (noon + H * 4) / 60 };
}

function getCurrentPlanetaryHour(lat, lon) {
    var now = new Date();
    var localHours = now.getHours() + now.getMinutes() / 60;
    var sunTimes = getSunTimes(lat || 41.9, lon || 12.5, now);
    var dayOfWeek = now.getDay();
    var dayRuler = DAY_RULERS[dayOfWeek];
    var rulerIndex = PLANETARY_ORDER.indexOf(dayRuler);
    var isDaytime = localHours >= sunTimes.sunrise && localHours < sunTimes.sunset;
    var hourLength, hourNum;
    
    if (isDaytime) {
        hourLength = (sunTimes.sunset - sunTimes.sunrise) / 12;
        hourNum = Math.floor((localHours - sunTimes.sunrise) / hourLength);
    } else {
        var nightLength = 24 - sunTimes.sunset + sunTimes.sunrise;
        hourLength = nightLength / 12;
        if (localHours >= sunTimes.sunset) {
            hourNum = Math.floor((localHours - sunTimes.sunset) / hourLength) + 12;
        } else {
            hourNum = Math.floor(((24 - sunTimes.sunset) + localHours) / hourLength) + 12;
        }
    }
    return PLANETARY_ORDER[(rulerIndex + hourNum) % 7];
}

function getAverageClickTime() {
    if (clickHistory.length < MIN_CLICKS_FOR_AVG) return null;
    var deltas = [];
    for (var i = 0; i < clickHistory.length; i++) {
        if (clickHistory[i].delta > 0) deltas.push(clickHistory[i].delta);
    }
    if (deltas.length < MIN_CLICKS_FOR_AVG) return null;
    var sum = 0;
    for (var i = 0; i < deltas.length; i++) sum += deltas[i];
    return sum / deltas.length;
}

function updateAvgDisplay() {
    var el = document.getElementById("avgTimeText");
    if (!el) return;
    var avg = getAverageClickTime();
    if (avg) {
        el.textContent = "Media: " + avg.toFixed(1) + "s/click";
    } else {
        var remaining = MIN_CLICKS_FOR_AVG - clickHistory.length;
        if (remaining > 0) {
            el.textContent = "Media: tra " + remaining + " click";
        }
    }
}

function updatePlanetaryDisplay() {
    currentPlanet = getCurrentPlanetaryHour();
    var el = document.getElementById("planetaryHourText");
    if (el && PLANETARY_NAMES[currentPlanet]) {
        var p = PLANETARY_NAMES[currentPlanet];
        el.textContent = p.symbol + " " + p.name;
    }
}

function updateMoonDisplay() {
    var moonSign = getMoonSign();
    var el = document.getElementById("moonSignText");
    if (el && moonSign) {
        el.textContent = moonSign.symbol + " " + moonSign.name;
    }
}

// ===== FUNZIONI RUNE MULTIPLE =====
function getCurrentRune() {
    return RUNES[currentRuneIndex] || RUNES[0] || {symbol: "", name: "", pronunciation: "", reps: state.vibTotal};
}

function updateRuneDisplay() {
    var rune = getCurrentRune();
    
    // Aggiorna simboli e nomi
    var symbolEl = document.getElementById("runeSymbols");
    var namesEl = document.getElementById("runeNames");
    
    if (RUNES.length > 1) {
        // Mostra la runa corrente evidenziata
        symbolEl.textContent = rune.symbol;
        namesEl.textContent = rune.name + " (" + (currentRuneIndex + 1) + "/" + RUNES.length + ")";
        
        // Aggiorna vibTotal per la runa corrente
        state.vibTotal = rune.reps;
        document.getElementById("vibTotal").textContent = rune.reps;
        document.getElementById("vibrationTarget").textContent = rune.reps;
    } else if (RUNES.length === 1) {
        symbolEl.textContent = rune.symbol;
        namesEl.textContent = rune.name;
    }
}

function onRuneComplete() {
    totalRunesCompleted += state.vibCount;
    
    if (currentRuneIndex < RUNES.length - 1) {
        // Passa alla runa successiva
        currentRuneIndex++;
        state.vibCount = 0;
        clickHistory = [];
        lastClickTime = null;
        
        // Aggiorna UI per la nuova runa
        updateRuneDisplay();
        updateVibrationUI();
        updateAvgDisplay();
        
        // Messaggio
        var rune = getCurrentRune();
        var msg = document.getElementById("vibMessage");
        if (msg) msg.textContent = "‚û°Ô∏è " + rune.symbol + " " + rune.name;
    } else {
        // Tutte le rune completate
        if (state.affTotal > 0) {
            setTimeout(switchToAffirmations, 800);
        } else {
            setTimeout(showComplete, 500);
        }
    }
}

function showClickWarning(avg, delta) {
    document.getElementById("warningMsg").textContent = "Hai cliccato molto pi√π velocemente della tua media.";
    document.getElementById("warningDetail").textContent = "Media: " + avg.toFixed(1) + "s - Questo click: " + delta.toFixed(1) + "s";
    document.getElementById("warningPopup").classList.add("show");
    if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]);
}

function hideClickWarning() {
    document.getElementById("warningPopup").classList.remove("show");
}

function confirmPendingClick() {
    if (pendingClick) {
        var timestamp = pendingClick.timestamp;
        var delta = pendingClick.delta;
        var n = pendingClick.n;
        pendingClick = null;
        hideClickWarning();
        
        lastClickTime = timestamp;
        clickHistory.push({rep: state.vibCount + 1, timestamp: timestamp, delta: delta, confirmed: true});
        
        var prev = state.vibCount;
        state.vibCount = Math.min(state.vibCount + n, state.vibTotal);
        if (state.sound) checkMilestone(prev, state.vibCount, state.vibTotal);
        updateVibrationUI();
        updateAvgDisplay();
        
        if (state.vibCount >= state.vibTotal) {
            // Per rune multiple, passa alla successiva
            if (RUNES.length > 1) {
                onRuneComplete();
            } else if (state.affTotal > 0) {
                setTimeout(switchToAffirmations, 800);
            } else {
                setTimeout(showComplete, 500);
            }
        }
    }
}

function cancelPendingClick() {
    pendingClick = null;
    hideClickWarning();
}

function buildDaysGrid() {
    var container = document.getElementById("daysGrid");
    container.innerHTML = "";
    var i, box;
    for (i = 1; i <= state.totalDays; i++) {
        box = document.createElement("div");
        box.className = "day-box";
        box.textContent = i;
        if (state.viewOnly) {
            if (i < state.completed) {
                box.className = "day-box completed";
            } else if (i === state.completed) {
                box.className = "day-box completed-today";
            }
        } else {
            if (i < state.day) {
                box.className = "day-box completed";
            } else if (i === state.day) {
                box.className = "day-box current";
            }
        }
        container.appendChild(box);
    }
    document.getElementById("daysProgress").textContent = (state.viewOnly ? state.completed : state.day - 1) + "/" + state.totalDays;
}

function addVibration(n) {
    if (state.viewOnly || state.phase !== "vibrations") return;
    state.sound = document.getElementById("soundToggle").checked;
    
    if (state.vibCount >= state.vibTotal) return;
    
    // Anti-click: solo per +1, solo dopo 10 ripetizioni
    if (n === 1) {
        var now = Date.now();
        var delta = lastClickTime ? (now - lastClickTime) / 1000 : 0;
        
        if (state.vibCount >= 10) {
            var avg = getAverageClickTime();
            if (avg && delta > 0 && delta < avg * THRESHOLD_FACTOR) {
                pendingClick = {timestamp: now, delta: delta, n: n};
                showClickWarning(avg, delta);
                return;
            }
        }
        
        lastClickTime = now;
        clickHistory.push({rep: state.vibCount + 1, timestamp: now, delta: delta});
        updateAvgDisplay();
    }
    
    var prev = state.vibCount;
    state.vibCount = Math.min(state.vibCount + n, state.vibTotal);
    if (state.sound) checkMilestone(prev, state.vibCount, state.vibTotal);
    updateVibrationUI();
    
    if (state.vibCount >= state.vibTotal) {
        // Per rune multiple, passa alla successiva
        if (RUNES.length > 1) {
            onRuneComplete();
        } else if (state.affTotal > 0) {
            setTimeout(switchToAffirmations, 800);
        } else {
            setTimeout(showComplete, 500);
        }
    }
}

function addAffirmation(n) {
    if (state.viewOnly || state.phase !== "affirmations") return;
    
    if (state.affCount >= state.affTotal) return;
    var prev = state.affCount;
    state.affCount = Math.min(state.affCount + n, state.affTotal);
    
    if (state.sound && state.affCount === state.affTotal - 1 && prev < state.affTotal - 1) {
        playAudio("audioLast");
    }
    
    updateAffirmationUI();
    
    if (state.affCount >= state.affTotal) {
        setTimeout(showComplete, 500);
    }
}

function checkMilestone(prev, curr, total) {
    if (curr === total - 1 && prev < total - 1) {
        playAudio("audioLast");
        return;
    }
    var milestones = [10, 20, 30, 40, 50, 100];
    var i, m;
    for (i = 0; i < milestones.length; i++) {
        m = milestones[i];
        if (prev < m && curr >= m && m <= total) {
            playAudio("audio" + m);
            return;
        }
    }
}

function switchToAffirmations() {
    state.phase = "affirmations";
    document.getElementById("step1").className = "step completed";
    document.getElementById("step2").className = "step active";
    document.getElementById("vibrationSection").style.display = "none";
    document.getElementById("vibrationInfo").style.display = "none";
    document.getElementById("affirmationSection").style.display = "block";
    updateAffirmationUI();
}

function updateVibrationUI() {
    document.getElementById("vibCount").textContent = state.vibCount;
    document.getElementById("vibTotal").textContent = state.vibTotal;
    var pct = Math.round((state.vibCount / state.vibTotal) * 100);
    document.getElementById("vibProgress").style.width = pct + "%";
    
    var left = state.vibTotal - state.vibCount;
    var msg = document.getElementById("vibMessage");
    if (left === 0) {
        msg.textContent = state.affTotal > 0 ? "‚úß Vibrazioni complete!" : "‚úß COMPLETATO ‚úß";
    } else if (left === 1) {
        msg.textContent = "‚ö° ULTIMA! ‚ö°";
    } else if (left <= 5) {
        msg.textContent = "‚ö° ULTIME " + left + "! ‚ö°";
    } else {
        msg.textContent = "";
    }
    
    // Disabilita bottoni se mancano poche ripetizioni
    var btn5 = document.getElementById("btnVibAdd5");
    var btn10 = document.getElementById("btnVibAdd10");
    if (left < 5) {
        btn5.disabled = true;
        btn5.style.opacity = "0.4";
    } else {
        btn5.disabled = false;
        btn5.style.opacity = "1";
    }
    if (left < 10) {
        btn10.disabled = true;
        btn10.style.opacity = "0.4";
    } else {
        btn10.disabled = false;
        btn10.style.opacity = "1";
    }
}

function updateAffirmationUI() {
    document.getElementById("affCount").textContent = state.affCount;
    document.getElementById("affTotal").textContent = state.affTotal;
    var pct = Math.round((state.affCount / state.affTotal) * 100);
    document.getElementById("affProgress").style.width = pct + "%";
    
    var left = state.affTotal - state.affCount;
    var msg = document.getElementById("affMessage");
    if (left === 0) {
        msg.textContent = "‚úß COMPLETATO ‚úß";
    } else if (left === 1) {
        msg.textContent = "‚ö° ULTIMA! ‚ö°";
    } else if (left <= 5) {
        msg.textContent = "‚ö° ULTIME " + left + "! ‚ö°";
    } else {
        msg.textContent = "";
    }
    
    // Disabilita bottoni se mancano poche ripetizioni
    var btn5 = document.getElementById("btnAffAdd5");
    var btn10 = document.getElementById("btnAffAdd10");
    if (left < 5) {
        btn5.disabled = true;
        btn5.style.opacity = "0.4";
    } else {
        btn5.disabled = false;
        btn5.style.opacity = "1";
    }
    if (left < 10) {
        btn10.disabled = true;
        btn10.style.opacity = "0.4";
    } else {
        btn10.disabled = false;
        btn10.style.opacity = "1";
    }
}

function playAudio(id) {
    var a = document.getElementById(id);
    if (a && a.src) {
        a.currentTime = 0;
        a.play().catch(function(e) { console.log("[AUDIO] Error:", e); });
    }
}

function showComplete() {
    if (state.sound) playAudio("audioComplete");
    document.getElementById("completedOverlay").className = "completed-overlay show";
}

function saveAndClose() {
    var endTimeISO = new Date().toISOString();
    var data = {
        action: "counter_complete",
        work_id: state.workId,
        vibrations: state.vibCount,
        affirmations: state.affCount,
        total_vibrations: state.vibTotal,
        total_affirmations: state.affTotal,
        start_planetary_hour: startPlanetaryHour,
        start_moon_sign: startMoonSign ? startMoonSign.name : null,
        start_time: startTimeISO,
        end_time: endTimeISO
    };
    console.log("[COUNTER] Saving:", JSON.stringify(data));
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.sendData(JSON.stringify(data));
        setTimeout(function() { window.Telegram.WebApp.close(); }, 300);
    } else {
        alert("Dati: " + JSON.stringify(data));
    }
}

function closeWebApp() {
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.close();
    }
}

function loadAudio() {
    if (!state.audioUrl) {
        console.log("[AUDIO] No audio URL provided");
        return;
    }
    var base = state.audioUrl + "/" + state.lang + "/";
    console.log("[AUDIO] Loading from:", base);
    var milestones = [10, 20, 30, 40, 50, 100];
    var i, el;
    for (i = 0; i < milestones.length; i++) {
        el = document.getElementById("audio" + milestones[i]);
        if (el) el.src = base + milestones[i] + ".mp3";
    }
    el = document.getElementById("audioLast");
    if (el) el.src = base + "last.mp3";
    el = document.getElementById("audioComplete");
    if (el) el.src = base + "complete.mp3";
}

function setupViewOnlyMode() {
    console.log("[COUNTER] Setting up view-only mode");
    document.getElementById("viewOnlyBanner").style.display = "block";
    document.getElementById("completedDayNum").textContent = state.completed;
    document.getElementById("viewOnlyInfo").style.display = "block";
    document.getElementById("stepIndicator").style.display = "none";
    document.getElementById("vibrationInfo").style.display = "none";
    document.getElementById("vibrationSection").style.display = "none";
    document.getElementById("affirmationSection").style.display = "none";
    document.getElementById("saveSection").style.display = "none";
    document.getElementById("closeSection").style.display = "block";
    
    document.getElementById("currentDay").textContent = state.completed;
    
    var remaining = state.totalDays - state.completed;
    var progressPct = Math.round((state.completed / state.totalDays) * 100);
    var endDate = new Date();
    endDate.setDate(endDate.getDate() + remaining);
    
    document.getElementById("infoCompleted").textContent = state.completed + " / " + state.totalDays;
    document.getElementById("infoRemaining").textContent = remaining;
    document.getElementById("infoEndDate").textContent = endDate.toLocaleDateString("it-IT", {day: "numeric", month: "long", year: "numeric"});
    document.getElementById("progressVisual").style.width = progressPct + "%";
    document.getElementById("progressVisual").textContent = progressPct + "%";
    
    if (state.affirmation) {
        document.getElementById("viewAffirmation").style.display = "block";
        document.getElementById("viewAffirmation").textContent = '"' + state.affirmation + '"';
    }
}

function init() {
    console.log("[COUNTER] Init v4 - with planetary hours, moon sign and anti-click...");
    
    // Salva ora planetaria, segno luna e timestamp di inizio (non cambieranno durante la sessione)
    startTimeISO = new Date().toISOString();
    currentPlanet = getCurrentPlanetaryHour();
    startPlanetaryHour = currentPlanet;
    startMoonSign = getMoonSign();
    
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.expand();
        window.Telegram.WebApp.ready();
    }
    
    var params = new URLSearchParams(window.location.search);
    state.workId = params.get("work_id") || "";
    state.vibTotal = parseInt(params.get("total")) || parseInt(params.get("vibrations")) || 40;
    state.affTotal = parseInt(params.get("aff_reps")) || 0;
    state.day = parseInt(params.get("day")) || 1;
    state.totalDays = parseInt(params.get("total_days")) || 40;
    state.completed = parseInt(params.get("completed")) || 0;
    state.workType = params.get("work_type") || "rune";
    state.lang = params.get("lang") || "it";
    state.viewOnly = params.get("view_only") === "1";
    
    var rawAudioUrl = params.get("audio_url") || "";
    if (rawAudioUrl) {
        try { state.audioUrl = decodeURIComponent(rawAudioUrl); } catch(e) { state.audioUrl = rawAudioUrl; }
    }
    
    var name = params.get("name") || "Lavoro";
    var affText = params.get("affirmation") || "";
    var runes = params.get("runes") || "";
    var runeNames = params.get("rune_names") || "";
    try { if (name) name = decodeURIComponent(name); } catch(e) {}
    try { if (affText) affText = decodeURIComponent(affText); } catch(e) {}
    try { if (runes) runes = decodeURIComponent(runes); } catch(e) {}
    try { if (runeNames) runeNames = decodeURIComponent(runeNames); } catch(e) {}
    
    state.name = name;
    state.affirmation = affText;
    state.runes = runes;
    state.runeNames = runeNames;
    
    // Parse runes_json per combinazioni multiple
    var runesJson = params.get("runes_json") || "";
    if (runesJson) {
        try {
            runesJson = decodeURIComponent(runesJson);
            RUNES = JSON.parse(runesJson);
            console.log("[COUNTER] Parsed RUNES:", RUNES.length, "rune(s)");
            
            // Se ci sono rune multiple, inizializza per la prima
            if (RUNES.length > 0) {
                currentRuneIndex = 0;
                var firstRune = RUNES[0];
                state.vibTotal = firstRune.reps || state.vibTotal;
            }
        } catch(e) {
            console.log("[COUNTER] Error parsing runes_json:", e);
        }
    }
    // Se non c'√® runes_json ma ci sono runes, crea una singola runa
    if (RUNES.length === 0 && runes) {
        var singleRune = {
            symbol: runes,
            name: runeNames || runes,
            pronunciation: runeNames || runes,
            reps: state.vibTotal
        };
        RUNES.push(singleRune);
        console.log("[COUNTER] Created single RUNE from params");
    }
    
    console.log("[COUNTER] State:", JSON.stringify(state));
    
    // Set work type label
    var typeLabels = {
        rune: "LAVORO RUNICO",
        spell: "INCANTESIMO",
        combo: "COMBINAZIONE RUNICA",
        custom: "LAVORO PERSONALIZZATO"
    };
    document.getElementById("workType").textContent = typeLabels[state.workType] || "LAVORO";
    document.getElementById("title").textContent = name;
    document.getElementById("currentDay").textContent = state.day;
    document.getElementById("totalDays").textContent = state.totalDays;
    document.getElementById("vibrationTarget").textContent = state.vibTotal;
    document.getElementById("vibTotal").textContent = state.vibTotal;
    
    // Show runes if present
    if (runes || RUNES.length > 0) {
        document.getElementById("runeDisplay").style.display = "block";
        if (RUNES.length > 1) {
            // Rune multiple - mostra la prima
            updateRuneDisplay();
        } else if (RUNES.length === 1) {
            // Singola runa
            document.getElementById("runeSymbols").textContent = RUNES[0].symbol;
            document.getElementById("runeNames").textContent = RUNES[0].name;
        } else {
            document.getElementById("runeSymbols").textContent = runes;
            if (runeNames) {
                document.getElementById("runeNames").textContent = runeNames;
            }
        }
    }
    
    // Set affirmation
    if (affText) {
        document.getElementById("affirmationText").textContent = '"' + affText + '"';
        document.getElementById("affTotal").textContent = state.affTotal;
    }
    
    if (state.viewOnly) {
        setupViewOnlyMode();
    } else {
        if (state.affTotal <= 0) {
            document.getElementById("step2").style.display = "none";
        }
        loadAudio();
        updateVibrationUI();
    }
    
    buildDaysGrid();
    
    // Bind vibration buttons
    document.getElementById("btnVibAdd1").onclick = function() { addVibration(1); };
    document.getElementById("btnVibAdd5").onclick = function() { addVibration(5); };
    document.getElementById("btnVibAdd10").onclick = function() { addVibration(10); };
    document.getElementById("btnVibMain").onclick = function() { addVibration(1); };
    
    // Bind affirmation buttons
    document.getElementById("btnAffAdd1").onclick = function() { addAffirmation(1); };
    document.getElementById("btnAffAdd5").onclick = function() { addAffirmation(5); };
    document.getElementById("btnAffAdd10").onclick = function() { addAffirmation(10); };
    document.getElementById("btnAffMain").onclick = function() { addAffirmation(1); };
    
    // Bind save/close
    document.getElementById("btnSave").onclick = saveAndClose;
    document.getElementById("btnClose").onclick = closeWebApp;
    document.getElementById("btnOverlayClose").onclick = saveAndClose;
    
    // Bind warning buttons
    document.getElementById("btnWarnCancel").onclick = cancelPendingClick;
    document.getElementById("btnWarnConfirm").onclick = confirmPendingClick;
    
    // Aggiorna display ora planetaria, luna e media
    updatePlanetaryDisplay();
    updateMoonDisplay();
    updateAvgDisplay();
    setInterval(updatePlanetaryDisplay, 60000);
}

init();
</script>
</body>
</html>
