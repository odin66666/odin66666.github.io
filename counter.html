<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Contatore</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #1a1a2e, #16213e); color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        h1 { text-align: center; color: #ffd700; font-size: 1.3rem; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #888; font-size: 0.9rem; margin-bottom: 20px; }
        .card { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(255,215,0,0.3); }
        .count { text-align: center; font-size: 4rem; font-weight: bold; color: #ffd700; }
        .total { text-align: center; color: #888; margin-bottom: 15px; }
        .progress { height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; overflow: hidden; margin-bottom: 15px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #7b2cbf, #ffd700); transition: width 0.3s; }
        .buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .btn { padding: 15px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; color: #fff; }
        .btn:active { transform: scale(0.95); }
        .btn-add { background: linear-gradient(135deg, #7b2cbf, #9d4edd); }
        .btn-main { grid-column: span 3; padding: 20px; font-size: 1.4rem; background: linear-gradient(135deg, #ffd700, #ffaa00); color: #1a1a1a; }
        .btn-save { grid-column: span 3; padding: 18px; font-size: 1.2rem; background: #10b981; margin-top: 15px; }
        .message { text-align: center; min-height: 30px; color: #ffd700; margin: 10px 0; }
        .debug { background: rgba(0,0,0,0.5); color: #0f0; font-size: 11px; padding: 10px; border-radius: 8px; margin-top: 15px; max-height: 100px; overflow: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="title">Lavoro</h1>
        <div class="subtitle" id="subtitle">Vibrazioni</div>
        
        <div class="card">
            <div class="count" id="count">0</div>
            <div class="total">di <span id="total">40</span></div>
            <div class="progress"><div class="progress-fill" id="progress"></div></div>
            <div class="message" id="message"></div>
            
            <div class="buttons">
                <button class="btn btn-add" onclick="add(1)">+1</button>
                <button class="btn btn-add" onclick="add(5)">+5</button>
                <button class="btn btn-add" onclick="add(10)">+10</button>
                <button class="btn btn-main" onclick="add(1)">⚡ VIBRA ⚡</button>
                <button class="btn btn-save" id="saveBtn" onclick="save()">✅ SALVA E CHIUDI</button>
            </div>
        </div>
        
        <div class="debug" id="debug">Debug: inizializzazione...</div>
    </div>
    
    <script>
        let count = 0;
        let total = 40;
        let workId = '';
        let affReps = 0;
        let affirmation = '';
        
        function log(msg) {
            console.log('[COUNTER]', msg);
            document.getElementById('debug').innerHTML += '<br>' + msg;
        }
        
        function init() {
            log('Init WebApp...');
            
            // Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.ready();
                log('Telegram WebApp OK');
            } else {
                log('ATTENZIONE: Telegram WebApp non disponibile!');
            }
            
            // Parametri URL
            const p = new URLSearchParams(window.location.search);
            workId = p.get('work_id') || '';
            total = parseInt(p.get('total')) || parseInt(p.get('vibrations')) || 40;
            affReps = parseInt(p.get('aff_reps')) || 0;
            affirmation = decodeURIComponent(p.get('affirmation') || '');
            const name = decodeURIComponent(p.get('name') || 'Lavoro');
            
            log('work_id=' + workId);
            log('total=' + total);
            log('aff_reps=' + affReps);
            
            document.getElementById('title').textContent = name;
            document.getElementById('total').textContent = total;
            
            update();
        }
        
        function add(n) {
            if (count >= total) return;
            count = Math.min(count + n, total);
            update();
            
            if (count >= total) {
                document.getElementById('message').textContent = '✅ COMPLETATO!';
                log('Completato! Mostra bottone salva');
            }
        }
        
        function update() {
            document.getElementById('count').textContent = count;
            document.getElementById('progress').style.width = Math.round((count / total) * 100) + '%';
            
            const left = total - count;
            if (left > 0 && left <= 5) {
                document.getElementById('message').textContent = '⚡ ULTIME ' + left + '!';
            } else if (left > 5) {
                document.getElementById('message').textContent = '';
            }
        }
        
        function save() {
            log('Salvataggio...');
            
            const data = {
                action: 'counter_complete',
                work_id: workId,
                vibrations: count,
                affirmations: affReps,
                total_vibrations: total,
                total_affirmations: affReps
            };
            
            const json = JSON.stringify(data);
            log('Dati: ' + json);
            
            if (window.Telegram && window.Telegram.WebApp) {
                try {
                    log('Invio sendData...');
                    window.Telegram.WebApp.sendData(json);
                    log('sendData OK!');
                    
                    setTimeout(function() {
                        log('Chiusura WebApp...');
                        window.Telegram.WebApp.close();
                    }, 500);
                } catch (e) {
                    log('ERRORE sendData: ' + e.message);
                    alert('Errore: ' + e.message);
                }
            } else {
                log('Telegram WebApp non disponibile per salvataggio');
                alert('Completato!\n\nDati:\n' + json + '\n\nChiudi manualmente.');
            }
        }
        
        init();
    </script>
</body>
</html>
