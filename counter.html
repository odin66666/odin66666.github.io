<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Contatore Vibrazioni</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cinzel', serif; background: #0a0a12; color: #e8e8e8; min-height: 100vh; padding: 15px; }
        .container { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 15px; }
        .header h1 { font-size: 1.3rem; color: #d4af37; }
        .header .subtitle { font-size: 0.85rem; color: #888; margin-top: 5px; }
        .step-indicator { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .step { padding: 8px 16px; border-radius: 20px; font-size: 0.75rem; background: rgba(255,255,255,0.1); color: #888; }
        .step.active { background: linear-gradient(135deg, #7b2cbf, #d4af37); color: white; }
        .step.completed { background: #10b981; color: white; }
        .card { background: #12121f; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(212, 175, 55, 0.3); }
        .count-display { text-align: center; margin-bottom: 15px; }
        .count-big { font-size: 4rem; font-weight: bold; color: #d4af37; }
        .count-total { font-size: 1rem; color: #888; }
        .progress-bar { height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #7b2cbf, #d4af37); transition: width 0.3s; }
        .message { text-align: center; font-size: 0.95rem; color: #f4d675; min-height: 25px; margin: 10px 0; }
        .affirmation { background: rgba(123, 44, 191, 0.15); border-radius: 10px; padding: 12px; margin: 15px 0; font-style: italic; font-size: 0.9rem; border-left: 3px solid #7b2cbf; display: none; }
        .buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .btn { padding: 15px; font-size: 1.1rem; font-weight: bold; font-family: 'Cinzel', serif; border: none; border-radius: 12px; cursor: pointer; color: white; }
        .btn:active { transform: scale(0.95); }
        .btn-add { background: linear-gradient(135deg, #7b2cbf, #9d4edd); }
        .btn-main { grid-column: span 3; padding: 18px; font-size: 1.3rem; background: linear-gradient(135deg, #d4af37, #c9a227); color: #1a1a1a; }
        .btn-save { grid-column: span 3; padding: 18px; font-size: 1.2rem; background: linear-gradient(135deg, #10b981, #059669); margin-top: 15px; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; font-size: 0.85rem; color: #888; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 15px; }
        .toggle { position: relative; width: 44px; height: 24px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.2); border-radius: 24px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle input:checked + .toggle-slider { background: #d4af37; }
        .toggle input:checked + .toggle-slider:before { transform: translateX(20px); }
        .completed-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(212, 175, 55, 0.95), rgba(123, 44, 191, 0.95)); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .completed-overlay.show { display: flex; }
        .completed-icon { font-size: 5rem; margin-bottom: 15px; }
        .completed-text { font-size: 1.8rem; color: #1a1a1a; margin-bottom: 25px; }
        .close-btn { padding: 15px 40px; background: #1a1a1a; color: #d4af37; border: 2px solid #d4af37; border-radius: 30px; font-family: 'Cinzel', serif; font-size: 1.1rem; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="title">Contatore</h1>
            <div class="subtitle">Vibrazioni Sacre</div>
        </div>
        
        <div class="step-indicator">
            <div class="step active" id="step1">Vibrazioni</div>
            <div class="step" id="step2">Affermazioni</div>
        </div>
        
        <div class="card">
            <div class="count-display">
                <div class="count-big" id="count">0</div>
                <div class="count-total">di <span id="total">40</span></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress" style="width: 0%"></div>
            </div>
            
            <div class="message" id="message"></div>
            
            <div class="affirmation" id="affirmationBox">
                <span id="affirmationText"></span>
            </div>
            
            <div class="buttons">
                <button class="btn btn-add" id="btnAdd1">+1</button>
                <button class="btn btn-add" id="btnAdd5">+5</button>
                <button class="btn btn-add" id="btnAdd10">+10</button>
                <button class="btn btn-main" id="mainBtn">VIBRA</button>
                <button class="btn btn-save" id="btnSave">SALVA E CHIUDI</button>
            </div>
            
            <div class="settings-row">
                <span>Suoni</span>
                <label class="toggle">
                    <input type="checkbox" id="soundToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>
    
    <div class="completed-overlay" id="completedOverlay">
        <div class="completed-icon">&#10022;</div>
        <div class="completed-text">COMPLETATO!</div>
        <button class="close-btn" id="btnOverlayClose">Salva e Chiudi</button>
    </div>
    
    <audio id="audio10" preload="auto"></audio>
    <audio id="audio20" preload="auto"></audio>
    <audio id="audio30" preload="auto"></audio>
    <audio id="audio40" preload="auto"></audio>
    <audio id="audio50" preload="auto"></audio>
    <audio id="audio100" preload="auto"></audio>
    <audio id="audioLast" preload="auto"></audio>
    <audio id="audioComplete" preload="auto"></audio>
    
<script>
var state = {
    step: 1,
    vibCount: 0,
    vibTotal: 40,
    affCount: 0,
    affTotal: 0,
    workId: "",
    audioUrl: "",
    lang: "it",
    sound: true
};

function addCount(n) {
    state.sound = document.getElementById("soundToggle").checked;
    
    if (state.step === 1) {
        if (state.vibCount >= state.vibTotal) return;
        var prev = state.vibCount;
        state.vibCount = Math.min(state.vibCount + n, state.vibTotal);
        if (state.sound) checkMilestone(prev, state.vibCount, state.vibTotal);
        updateUI();
        if (state.vibCount >= state.vibTotal) {
            if (state.affTotal > 0) {
                setTimeout(switchToAffirmations, 800);
            } else {
                setTimeout(showComplete, 500);
            }
        }
    } else {
        if (state.affCount >= state.affTotal) return;
        var prev2 = state.affCount;
        state.affCount = Math.min(state.affCount + n, state.affTotal);
        if (state.sound && state.affCount === state.affTotal - 1 && prev2 < state.affTotal - 1) {
            playAudio("audioLast");
        }
        updateUI();
        if (state.affCount >= state.affTotal) {
            setTimeout(showComplete, 500);
        }
    }
}

function checkMilestone(prev, curr, total) {
    if (curr === total - 1 && prev < total - 1) {
        playAudio("audioLast");
        return;
    }
    var milestones = [10, 20, 30, 40, 50, 100];
    var i, m;
    for (i = 0; i < milestones.length; i++) {
        m = milestones[i];
        if (prev < m && curr >= m && m <= total) {
            playAudio("audio" + m);
            return;
        }
    }
}

function switchToAffirmations() {
    state.step = 2;
    document.getElementById("step1").className = "step completed";
    document.getElementById("step2").className = "step active";
    document.getElementById("mainBtn").textContent = "RECITA";
    document.getElementById("affirmationBox").style.display = "block";
    updateUI();
}

function updateUI() {
    var curr = state.step === 1 ? state.vibCount : state.affCount;
    var total = state.step === 1 ? state.vibTotal : state.affTotal;
    document.getElementById("count").textContent = curr;
    document.getElementById("total").textContent = total;
    var pct = Math.round((curr / total) * 100);
    document.getElementById("progress").style.width = pct + "%";
    var left = total - curr;
    var msg = document.getElementById("message");
    if (left === 0) {
        msg.textContent = state.step === 1 && state.affTotal > 0 ? "Ora le affermazioni..." : "COMPLETATO";
    } else if (left === 1) {
        msg.textContent = "ULTIMA!";
    } else if (left <= 5) {
        msg.textContent = "ULTIME " + left + "!";
    } else {
        msg.textContent = "";
    }
}

function playAudio(id) {
    var a = document.getElementById(id);
    if (a && a.src) {
        a.currentTime = 0;
        a.play();
    }
}

function showComplete() {
    if (state.sound) playAudio("audioComplete");
    document.getElementById("completedOverlay").className = "completed-overlay show";
}

function saveAndClose() {
    var data = {
        action: "counter_complete",
        work_id: state.workId,
        vibrations: state.vibCount,
        affirmations: state.affCount,
        total_vibrations: state.vibTotal,
        total_affirmations: state.affTotal
    };
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.sendData(JSON.stringify(data));
        setTimeout(function() { window.Telegram.WebApp.close(); }, 300);
    } else {
        alert("Dati: " + JSON.stringify(data));
    }
}

function loadAudio() {
    if (!state.audioUrl) return;
    var base = state.audioUrl + "/" + state.lang + "/";
    var milestones = [10, 20, 30, 40, 50, 100];
    var i, el;
    for (i = 0; i < milestones.length; i++) {
        el = document.getElementById("audio" + milestones[i]);
        if (el) el.src = base + milestones[i] + ".mp3";
    }
    el = document.getElementById("audioLast");
    if (el) el.src = base + "last.mp3";
    el = document.getElementById("audioComplete");
    if (el) el.src = base + "complete.mp3";
}

function init() {
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.expand();
        window.Telegram.WebApp.ready();
    }
    
    var params = new URLSearchParams(window.location.search);
    state.workId = params.get("work_id") || "";
    state.vibTotal = parseInt(params.get("total")) || parseInt(params.get("vibrations")) || 40;
    state.affTotal = parseInt(params.get("aff_reps")) || 0;
    state.lang = params.get("lang") || "it";
    
    var rawAudioUrl = params.get("audio_url") || "";
    if (rawAudioUrl) {
        try { state.audioUrl = decodeURIComponent(rawAudioUrl); } catch(e) { state.audioUrl = rawAudioUrl; }
    }
    
    var name = params.get("name") || "Lavoro";
    var affText = params.get("affirmation") || "";
    try { if (name) name = decodeURIComponent(name); } catch(e) {}
    try { if (affText) affText = decodeURIComponent(affText); } catch(e) {}
    
    document.getElementById("title").textContent = name;
    document.getElementById("total").textContent = state.vibTotal;
    
    if (affText) {
        document.getElementById("affirmationText").textContent = affText;
    }
    
    if (state.affTotal <= 0) {
        document.getElementById("step2").style.display = "none";
    }
    
    loadAudio();
    updateUI();
    
    document.getElementById("btnAdd1").onclick = function() { addCount(1); };
    document.getElementById("btnAdd5").onclick = function() { addCount(5); };
    document.getElementById("btnAdd10").onclick = function() { addCount(10); };
    document.getElementById("mainBtn").onclick = function() { addCount(1); };
    document.getElementById("btnSave").onclick = saveAndClose;
    document.getElementById("btnOverlayClose").onclick = saveAndClose;
}

init();
</script>
</body>
</html>
