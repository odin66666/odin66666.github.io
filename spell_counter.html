<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Contatore Incantesimi</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root { --bg: #0a0a0f; --card: #12121a; --gold: #d4af37; --text: #e8e8e8; --dim: #888; --success: #4ade80; --warning: #fbbf24; --error: #ef4444; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 12px; min-height: 100vh; }
    .container { max-width: 500px; margin: 0 auto; }
    .header { text-align: center; padding: 12px 0; border-bottom: 1px solid rgba(212,175,55,0.3); margin-bottom: 12px; }
    .header h1 { font-size: 18px; color: var(--gold); margin-bottom: 4px; }
    .header .cat { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
    .header .cat.mantra { color: #ff9800; } .header .cat.necronomicon { color: #9c27b0; } .header .cat.aura { color: #00bcd4; }
    .info-bar { display: flex; justify-content: space-around; background: var(--card); border-radius: 8px; padding: 10px; margin-bottom: 12px; }
    .info-item { text-align: center; }
    .info-item .val { font-size: 14px; font-weight: bold; color: var(--gold); }
    .info-item .lbl { font-size: 9px; color: var(--dim); text-transform: uppercase; }
    .planet-bar { background: var(--card); border-radius: 8px; padding: 10px; margin-bottom: 12px; text-align: center; }
    .planet-bar .lbl { font-size: 9px; color: var(--dim); text-transform: uppercase; margin-bottom: 4px; }
    .planet-bar .planet { font-size: 16px; font-weight: bold; }
    .phase-indicator { background: var(--card); border-radius: 8px; padding: 8px; margin-bottom: 12px; text-align: center; }
    .phase-indicator .lbl { font-size: 10px; color: var(--dim); }
    .phase-indicator .phase { font-size: 14px; color: var(--gold); font-weight: bold; }
    .mantra-box { background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05)); border: 1px solid rgba(212,175,55,0.3); border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: center; }
    .mantra-box .lbl { font-size: 9px; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .mantra-box .text { font-size: 20px; font-weight: bold; color: var(--gold); word-break: break-word; line-height: 1.3; }
    .mantra-box .pron { font-size: 11px; color: var(--dim); margin-top: 6px; font-style: italic; }
    .counter-section { text-align: center; padding: 20px 0; }
    .counter-ring { width: 180px; height: 180px; margin: 0 auto 15px; position: relative; }
    .counter-ring svg { transform: rotate(-90deg); }
    .counter-ring circle { fill: none; stroke-width: 8; }
    .counter-ring .bg { stroke: var(--card); }
    .counter-ring .progress { stroke: var(--gold); stroke-linecap: round; transition: stroke-dashoffset 0.3s; }
    .counter-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    .counter-display .num { font-size: 48px; font-weight: bold; color: var(--gold); line-height: 1; }
    .counter-display .of { font-size: 14px; color: var(--dim); }
    .tap-area { width: 100%; padding: 25px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; margin-bottom: 12px; transition: all 0.1s; }
    .tap-area:active { transform: scale(0.98); }
    .tap-area.primary { background: linear-gradient(135deg, var(--gold), #b8960f); color: #000; }
    .tap-area.complete { background: linear-gradient(135deg, var(--success), #22c55e); color: #000; }
    .controls { display: flex; gap: 10px; margin-bottom: 15px; }
    .ctrl-btn { flex: 1; padding: 12px; border: 1px solid var(--dim); background: transparent; color: var(--dim); border-radius: 8px; font-size: 13px; cursor: pointer; }
    .ctrl-btn:active { border-color: var(--gold); color: var(--gold); }
    .aff-section { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
    .aff-section .lbl { font-size: 9px; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .aff-section .text { font-size: 13px; font-style: italic; color: var(--text); line-height: 1.5; margin-bottom: 12px; }
    .aff-section .counter { font-size: 14px; color: var(--gold); margin-bottom: 10px; }
    .progress-info { background: var(--card); border-radius: 8px; padding: 12px; margin-bottom: 15px; }
    .progress-info .row { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .progress-info .row:last-child { margin-bottom: 0; }
    .progress-info .lbl { font-size: 12px; color: var(--dim); }
    .progress-info .val { font-size: 12px; color: var(--text); font-weight: bold; }
    .status-complete { text-align: center; padding: 40px 20px; }
    .status-complete .icon { font-size: 64px; margin-bottom: 15px; }
    .status-complete .title { font-size: 22px; color: var(--gold); font-weight: bold; margin-bottom: 8px; }
    .status-complete .sub { font-size: 14px; color: var(--dim); margin-bottom: 20px; }
    .status-complete .btn { padding: 15px 30px; background: var(--gold); color: #000; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .timer { font-size: 12px; color: var(--dim); text-align: center; margin-bottom: 10px; }
    .avg-time { font-size: 11px; color: var(--dim); text-align: center; margin-bottom: 10px; }
    .warning-popup { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .warning-box { background: var(--card); border: 2px solid var(--warning); border-radius: 16px; padding: 25px; max-width: 350px; text-align: center; }
    .warning-box .icon { font-size: 50px; margin-bottom: 15px; }
    .warning-box .title { font-size: 18px; color: var(--warning); font-weight: bold; margin-bottom: 10px; }
    .warning-box .msg { font-size: 14px; color: var(--text); margin-bottom: 8px; }
    .warning-box .detail { font-size: 12px; color: var(--dim); margin-bottom: 20px; }
    .warning-box .btns { display: flex; gap: 10px; }
    .warning-box .btns button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; }
    .warning-box .btn-cancel { background: var(--error); color: #fff; }
    .warning-box .btn-confirm { background: var(--success); color: #000; }
    .history-popup { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding: 20px; }
    .history-box { background: var(--card); border-radius: 12px; padding: 20px; max-width: 400px; margin: 0 auto; }
    .history-box .title { font-size: 16px; color: var(--gold); font-weight: bold; margin-bottom: 15px; text-align: center; }
    .history-list { max-height: 400px; overflow-y: auto; }
    .history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 12px; }
    .history-item .rep { color: var(--gold); font-weight: bold; }
    .history-item .time { color: var(--dim); }
    .history-item .delta { color: var(--text); }
    .history-item.warning { background: rgba(251,191,36,0.2); }
    .hide { display: none !important; }
    .c-sun { color: #ffd700; } .c-moon { color: #c0c0c0; } .c-mars { color: #ff4444; }
    .c-mercury { color: #8b4513; } .c-jupiter { color: #ff8c00; } .c-venus { color: #90ee90; } .c-saturn { color: #4a4a4a; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 id="spellName">Caricamento...</h1>
    <div class="cat" id="catLabel">Incantesimo</div>
  </div>
  <div class="info-bar">
    <div class="info-item"><div class="val" id="dayNum">1</div><div class="lbl">Giorno</div></div>
    <div class="info-item"><div class="val" id="dayName">---</div><div class="lbl">Oggi</div></div>
    <div class="info-item"><div class="val" id="timeNow">--:--</div><div class="lbl">Ora</div></div>
  </div>
  <div class="planet-bar">
    <div class="lbl">Ora Planetaria</div>
    <div class="planet" id="planetText">Calcolo...</div>
  </div>
  <div class="planet-bar" id="moonBar">
    <div class="lbl">Luna in</div>
    <div class="planet" id="moonText">Calcolo...</div>
  </div>
  <div class="phase-indicator hide" id="phaseIndicator">
    <div class="lbl">Fase</div>
    <div class="phase" id="phaseText">1/2</div>
  </div>
  <div id="mainSection">
    <div class="mantra-box">
      <div class="lbl">üìä Vibrazione</div>
      <div class="text" id="mantraText">---</div>
      <div class="pron" id="pronText"></div>
    </div>
    <div class="counter-section">
      <div class="counter-ring">
        <svg width="180" height="180">
          <circle class="bg" cx="90" cy="90" r="82"></circle>
          <circle class="progress" id="progressRing" cx="90" cy="90" r="82" stroke-dasharray="515" stroke-dashoffset="515"></circle>
        </svg>
        <div class="counter-display">
          <div class="num" id="countNum">0</div>
          <div class="of">di <span id="totalReps">108</span></div>
        </div>
      </div>
      <div class="timer" id="timerText">√¢¬è¬±√Ø¬∏¬è 00:00</div>
      <div class="avg-time" id="avgTimeText">Media: -- sec/rep</div>
      <button class="tap-area primary" id="tapBtn" onclick="incrementCounter()">üì¢ TOCCA PER CONTARE</button>
      <div class="controls">
        <button class="ctrl-btn" onclick="decrementCounter()">√¢≈æ‚Äì Correggi</button>
        <button class="ctrl-btn" onclick="showHistory()">üìú Storico</button>
        <button class="ctrl-btn" onclick="resetCounter()">√¢‚Ä†¬∫ Reset</button>
      </div>
    </div>
  </div>
  <div class="aff-section hide" id="affSection">
    <div class="lbl">‚úçÔ∏è Affermazione</div>
    <div class="text" id="affText"></div>
    <div class="counter">Ripeti: <span id="affDone">0</span> / <span id="affTotal">3</span></div>
    <button class="tap-area primary" onclick="incrementAff()">üì£ AFFERMA</button>
  </div>
  <div class="progress-info" id="progressInfo">
    <div class="row"><span class="lbl">Durata lavoro:</span><span class="val" id="durationText">40 giorni</span></div>
    <div class="row"><span class="lbl">Giorni completati:</span><span class="val" id="daysCompleted">0 / 40</span></div>
  </div>
  <div class="status-complete hide" id="completeSection">
    <div class="icon">‚úÖ</div>
    <div class="title">Sessione Completata!</div>
    <div class="sub" id="completeMsg">Ottimo lavoro!</div>
    <button class="btn" onclick="saveAndClose()">üíæ SALVA E CHIUDI</button>
  </div>
</div>
<div class="warning-popup hide" id="warningPopup">
  <div class="warning-box">
    <div class="icon">√¢≈°¬†√Ø¬∏¬è</div>
    <div class="title">Click troppo veloce!</div>
    <div class="msg" id="warningMsg">Hai cliccato molto pi√π velocemente della tua media.</div>
    <div class="detail" id="warningDetail">Media: 5.2s - Questo click: 1.3s</div>
    <div class="btns">
      <button class="btn-cancel" onclick="cancelClick()">√¢¬ù≈í Annulla</button>
      <button class="btn-confirm" onclick="confirmClick()">‚úÖ Conferma</button>
    </div>
  </div>
</div>
<div class="history-popup hide" id="historyPopup">
  <div class="history-box">
    <div class="title">üìú Storico Click</div>
    <div class="history-list" id="historyList"></div>
    <button class="tap-area primary" style="margin-top:15px" onclick="hideHistory()">CHIUDI</button>
  </div>
</div>
<script>
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

let audioCtx = null;
function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playTick() { initAudio(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g);g.connect(audioCtx.destination); o.frequency.value=800;o.type='sine'; g.gain.setValueAtTime(0.3,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.1); o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.1); }
function playLast() { initAudio(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g);g.connect(audioCtx.destination); o.frequency.value=1200;o.type='sine'; g.gain.setValueAtTime(0.4,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3); o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.3); }
function playComplete() { initAudio(); [523,659,784,1047].forEach((f,i)=>{ setTimeout(()=>{ const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g);g.connect(audioCtx.destination); o.frequency.value=f;o.type='sine'; g.gain.setValueAtTime(0.3,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.2); o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.2); },i*150); }); }
function playWarning() { initAudio(); [400,400,600].forEach((f,i)=>{ setTimeout(()=>{ const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g);g.connect(audioCtx.destination); o.frequency.value=f;o.type='square'; g.gain.setValueAtTime(0.4,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.15); o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.15); },i*180); }); }

const P = new URLSearchParams(window.location.search);
const USER_ID = P.get('user_id') || '0';
const SPELL_ID = P.get('spell_id') || '';
const SPELL_NAME = decodeURIComponent(P.get('spell_name') || 'Incantesimo');
const CATEGORY = P.get('category') || 'mantra';
const DURATION = parseInt(P.get('duration')) || 0;
const AFFIRMATION = decodeURIComponent(P.get('affirmation') || '');
const AFF_REPS = parseInt(P.get('aff_reps')) || 3;
const DAY_NUM = parseInt(P.get('day_num')) || 1;
const DAYS_TOTAL = parseInt(P.get('days_total')) || DURATION || 0;
const LAT = parseFloat(P.get('lat')) || 41.9028;
const LON = parseFloat(P.get('lon')) || 12.4964;
const TZ = P.get('tz') !== null ? parseFloat(P.get('tz')) : 1;

let MANTRAS = [];
const mantrasJson = P.get('mantras_json');
if (mantrasJson) { try { MANTRAS = JSON.parse(decodeURIComponent(mantrasJson)); } catch(e) {} }
if (MANTRAS.length === 0) { MANTRAS = [{ word: decodeURIComponent(P.get('mantra') || '---'), pronunciation: decodeURIComponent(P.get('pronunciation') || ''), reps: parseInt(P.get('reps')) || 108 }]; }

let currentMantraIndex = 0, count = 0, totalRepsCompleted = 0, affCount = 0, phase = 'counting', startTime = Date.now(), currentPlanet = null, startMoonSign = null;
let clickHistory = [], lastClickTime = null, pendingClick = null;
const MIN_CLICKS_FOR_AVG = 10, THRESHOLD_FACTOR = 0.4;

// Dati sessione per salvataggio finale
let sessionData = null;

const DAYS_IT = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
const PLANETS = { sun:{s:'‚òâ',n:'Sole',c:'c-sun'}, moon:{s:'‚òΩ',n:'Luna',c:'c-moon'}, mars:{s:'‚ôÇ',n:'Marte',c:'c-mars'}, mercury:{s:'‚òø',n:'Mercurio',c:'c-mercury'}, jupiter:{s:'‚ôÉ',n:'Giove',c:'c-jupiter'}, venus:{s:'‚ôÄ',n:'Venere',c:'c-venus'}, saturn:{s:'‚ôÑ',n:'Saturno',c:'c-saturn'} };
const SEQ = ['saturn','jupiter','mars','sun','venus','mercury','moon'];
const RULERS = {0:'moon',1:'mars',2:'mercury',3:'jupiter',4:'venus',5:'saturn',6:'sun'};

const ZODIAC_SIGNS = [
    {name: "Ariete", symbol: "‚ôà"},
    {name: "Toro", symbol: "‚ôâ"},
    {name: "Gemelli", symbol: "‚ôä"},
    {name: "Cancro", symbol: "‚ôã"},
    {name: "Leone", symbol: "‚ôå"},
    {name: "Vergine", symbol: "‚ôç"},
    {name: "Bilancia", symbol: "‚ôé"},
    {name: "Scorpione", symbol: "‚ôè"},
    {name: "Sagittario", symbol: "‚ôê"},
    {name: "Capricorno", symbol: "‚ôë"},
    {name: "Acquario", symbol: "‚ôí"},
    {name: "Pesci", symbol: "‚ôì"}
];

function getMoonSign() {
    const now = new Date();
    const epoch = new Date(2000, 0, 6, 18, 0, 0);
    const msPerDay = 86400000;
    const daysSinceEpoch = (now - epoch) / msPerDay;
    const lunarCycle = 27.321661;
    const daysPerSign = lunarCycle / 12;
    const positionInCycle = daysSinceEpoch % lunarCycle;
    const signIndex = Math.floor(positionInCycle / daysPerSign) % 12;
    return ZODIAC_SIGNS[signIndex];
}

function updateMoonDisplay() {
    const moon = getMoonSign();
    document.getElementById('moonText').innerHTML = `<span style="color:#9d4edd">${moon.symbol} ${moon.name}</span>`;
}

function sunTimesMin(lat,lon,doy,tz) { const latRad=lat*Math.PI/180,dec=-23.45*Math.cos(2*Math.PI/365*(doy+10)),decRad=dec*Math.PI/180,B=2*Math.PI/365*(doy-81),eot=9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B); let cosH=(Math.cos(90.833*Math.PI/180)-Math.sin(latRad)*Math.sin(decRad))/(Math.cos(latRad)*Math.cos(decRad)); cosH=Math.max(-1,Math.min(1,cosH)); const H=Math.acos(cosH)*180/Math.PI,noon=720-(lon*4)-eot; return {sr:noon-(H*4)+(tz*60),ss:noon+(H*4)+(tz*60)}; }
function getCurrentPlanetaryHour() { const now=new Date(),doy=Math.floor((now-new Date(now.getFullYear(),0,0))/86400000),nowMin=now.getHours()*60+now.getMinutes(),dow=now.getDay(),{sr,ss}=sunTimesMin(LAT,LON,doy,TZ),{sr:nextSr}=sunTimesMin(LAT,LON,doy+1,TZ),pyDay=(dow+6)%7,ri=SEQ.indexOf(RULERS[pyDay]); let hourIndex; if(nowMin>=sr&&nowMin<ss){hourIndex=Math.floor((nowMin-sr)/((ss-sr)/12));}else{const hourLen=((nextSr+1440)-ss)/12;hourIndex=(nowMin>=ss?Math.floor((nowMin-ss)/hourLen):Math.floor((nowMin+1440-ss)/hourLen))+12;} return SEQ[(ri+hourIndex)%7]; }
function updatePlanetDisplay() { currentPlanet=getCurrentPlanetaryHour(); const p=PLANETS[currentPlanet]; document.getElementById('planetText').innerHTML=`<span class="${p.c}">${p.s} ${p.n}</span>`; }
function updateTimer() { const e=Math.floor((Date.now()-startTime)/1000),m=Math.floor(e/60).toString().padStart(2,'0'),s=(e%60).toString().padStart(2,'0'); document.getElementById('timerText').textContent=`√¢¬è¬±√Ø¬∏¬è ${m}:${s}`; document.getElementById('timeNow').textContent=new Date().toTimeString().slice(0,5); }
function getAverageClickTime() { if(clickHistory.length<MIN_CLICKS_FOR_AVG)return null; const d=clickHistory.filter(c=>c.delta>0).map(c=>c.delta); if(d.length<MIN_CLICKS_FOR_AVG)return null; return d.reduce((a,b)=>a+b,0)/d.length; }
function updateAvgDisplay() { const a=getAverageClickTime(); if(a){document.getElementById('avgTimeText').textContent=`Media: ${a.toFixed(1)} sec/rep`;}else{document.getElementById('avgTimeText').textContent=`Media: calcolo tra ${MIN_CLICKS_FOR_AVG-clickHistory.length} click`;} }
function getCurrentMantra() { return MANTRAS[currentMantraIndex] || MANTRAS[0]; }
function updateMantraDisplay() { const m=getCurrentMantra(); document.getElementById('mantraText').textContent=m.word; document.getElementById('pronText').textContent=m.pronunciation||''; document.getElementById('totalReps').textContent=m.reps; if(MANTRAS.length>1){document.getElementById('phaseIndicator').classList.remove('hide');document.getElementById('phaseText').textContent=`${currentMantraIndex+1}/${MANTRAS.length}: ${m.word}`;} }
function updateCounterDisplay() { const m=getCurrentMantra(); document.getElementById('countNum').textContent=count; document.getElementById('progressRing').style.strokeDashoffset=515*(1-count/m.reps); const r=document.getElementById('progressRing'); if(count>=m.reps-3&&count<m.reps)r.style.stroke='#fbbf24'; else if(count>=m.reps)r.style.stroke='#4ade80'; else r.style.stroke='#d4af37'; }
function showWarning(avg,click) { document.getElementById('warningMsg').textContent='Hai cliccato molto pi√π velocemente della tua media.'; document.getElementById('warningDetail').textContent=`Media: ${avg.toFixed(1)}s - Questo click: ${click.toFixed(1)}s`; document.getElementById('warningPopup').classList.remove('hide'); playWarning(); if(navigator.vibrate)navigator.vibrate([200,100,200,100,200]); }
function hideWarning() { document.getElementById('warningPopup').classList.add('hide'); }
function cancelClick() { pendingClick=null; hideWarning(); }
function confirmClick() { if(pendingClick){applyClick(pendingClick.timestamp,pendingClick.delta,true);pendingClick=null;} hideWarning(); }
function applyClick(ts,delta,confirmed=false) { const m=getCurrentMantra(); count++; clickHistory.push({rep:count,timestamp:ts,delta:delta,confirmed:confirmed}); updateCounterDisplay(); updateAvgDisplay(); if(count===m.reps-1){playLast();if(navigator.vibrate)navigator.vibrate([100,50,100]);}else if(count>=m.reps){playComplete();if(navigator.vibrate)navigator.vibrate([100,50,100,50,200]);totalRepsCompleted+=count;if(currentMantraIndex<MANTRAS.length-1){setTimeout(()=>{currentMantraIndex++;count=0;clickHistory=[];lastClickTime=null;updateMantraDisplay();updateCounterDisplay();updateAvgDisplay();},1000);}else{onCountingComplete();}}else{playTick();if(navigator.vibrate)navigator.vibrate(20);} }
function incrementCounter() { const m=getCurrentMantra(); if(count>=m.reps)return; const now=Date.now(),delta=lastClickTime?(now-lastClickTime)/1000:0,avg=getAverageClickTime(); if(avg&&delta>0&&delta<avg*THRESHOLD_FACTOR){pendingClick={timestamp:now,delta:delta};showWarning(avg,delta);return;} lastClickTime=now; applyClick(now,delta); }
function decrementCounter() { if(count>0){count--;if(clickHistory.length>0)clickHistory.pop();updateCounterDisplay();updateAvgDisplay();} }
function resetCounter() { if(confirm('Vuoi resettare il contatore corrente?')){count=0;clickHistory=[];lastClickTime=null;updateCounterDisplay();updateAvgDisplay();} }
function showHistory() { const l=document.getElementById('historyList'); l.innerHTML=''; if(clickHistory.length===0){l.innerHTML='<div style="text-align:center;color:var(--dim);padding:20px">Nessun click registrato</div>';}else{clickHistory.forEach(c=>{const d=document.createElement('div');d.className='history-item'+(c.confirmed?' warning':'');const t=new Date(c.timestamp).toTimeString().slice(0,8),dt=c.delta>0?`+${c.delta.toFixed(1)}s`:'-';d.innerHTML=`<span class="rep">Rep ${c.rep}</span><span class="time">${t}</span><span class="delta">${dt}${c.confirmed?' √¢≈°¬†√Ø¬∏¬è':''}</span>`;l.appendChild(d);});} document.getElementById('historyPopup').classList.remove('hide'); }
function hideHistory() { document.getElementById('historyPopup').classList.add('hide'); }
function onCountingComplete() { if(AFFIRMATION&&AFFIRMATION!=='undefined'&&AFFIRMATION.length>5){phase='affirming';document.getElementById('mainSection').classList.add('hide');document.getElementById('affSection').classList.remove('hide');}else{showCompleteScreen();} }
function incrementAff() { affCount++; document.getElementById('affDone').textContent=affCount; playTick(); if(navigator.vibrate)navigator.vibrate(50); if(affCount>=AFF_REPS){playComplete();showCompleteScreen();} }

function showCompleteScreen() {
  phase = 'complete';
  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  const totalReps = MANTRAS.reduce((s, m) => s + m.reps, 0);
  
  // Salva i dati per quando l'utente preme CHIUDI
  sessionData = {
    action: 'spell_session_complete',
    user_id: USER_ID,
    spell_id: SPELL_ID,
    reps_done: totalReps,
    aff_done: affCount,
    duration_seconds: elapsed,
    planetary_hour: currentPlanet,
    moon_sign: startMoonSign ? startMoonSign.name : null,
    day_of_week: DAYS_IT[new Date().getDay()],
    timestamp: new Date().toISOString()
  };
  
  document.getElementById('mainSection').classList.add('hide');
  document.getElementById('affSection').classList.add('hide');
  document.getElementById('progressInfo').classList.add('hide');
  document.getElementById('phaseIndicator').classList.add('hide');
  document.getElementById('completeSection').classList.remove('hide');
  
  let msg = `${totalReps} ripetizioni in ${Math.floor(elapsed/60)}m ${elapsed%60}s`;
  if (DURATION > 0) msg += ` ‚Ä¢ Giorno ${DAY_NUM}/${DAYS_TOTAL}`;
  document.getElementById('completeMsg').textContent = msg;
}

function saveAndClose() {
  // Invia dati a Telegram - questo chiuder√† automaticamente la webapp
  if (tg && sessionData) {
    tg.sendData(JSON.stringify(sessionData));
    // sendData chiude automaticamente la webapp
  } else {
    // Fallback se non in Telegram
    alert('Sessione completata!');
  }
}

function init() { 
  document.getElementById('spellName').textContent=SPELL_NAME; 
  const c=document.getElementById('catLabel'); 
  c.classList.add(CATEGORY); 
  if(CATEGORY==='mantra')c.textContent='üïâÔ∏è Mantra Sanscrito'; 
  else if(CATEGORY==='necronomicon')c.textContent='üìú Necronomicon'; 
  else if(CATEGORY==='aura')c.textContent='üîÆ Aura Magick'; 
  document.getElementById('dayNum').textContent=DAY_NUM; 
  document.getElementById('dayName').textContent=DAYS_IT[new Date().getDay()]; 
  updateMantraDisplay(); 
  updateCounterDisplay(); 
  updateAvgDisplay(); 
  if(AFFIRMATION&&AFFIRMATION!=='undefined'&&AFFIRMATION.length>5){
    document.getElementById('affText').textContent=AFFIRMATION;
    document.getElementById('affTotal').textContent=AFF_REPS;
  } 
  if(DURATION>0){
    document.getElementById('durationText').textContent=`${DURATION} giorni`;
    document.getElementById('daysCompleted').textContent=`${DAY_NUM-1} / ${DURATION}`;
  }else{
    document.getElementById('progressInfo').classList.add('hide');
  }
  // Salva segno luna all'inizio
  startMoonSign = getMoonSign();
  updatePlanetDisplay();
  updateMoonDisplay(); 
  setInterval(updateTimer,1000); 
  setInterval(updatePlanetDisplay,60000); 
  updateTimer(); 
  document.body.addEventListener('click',initAudio,{once:true}); 
}

init();
</script>
</body>
</html>
